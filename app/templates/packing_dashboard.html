<!-- # app/templates/packing_dashboard.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Staff Camera Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <style>
        /* Container wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö video stream, spinner ‡πÅ‡∏•‡∏∞ overlay */
        .video-container {
            position: relative;
            display: inline-block;
            border: 3px solid #3498db;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 15px;
            width: 100%;
            max-width: 640px;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û stream */
        #stream {
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 640px;
            height: 480px;
            display: block;
        }

        /* Responsive CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        @media (max-width: 1280px) {

            /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1280px */
            .video-container {
                width: 100% !important;
                max-width: 600px;
            }

            #camera-stream {
                width: 100% !important;
                max-width: 600px !important;
                height: auto !important;
            }

            #detection-canvas {
                width: 100% !important;
                max-width: 600px !important;
                height: auto !important;
            }
        }

        @media (max-width: 1024px) {

            /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1024px - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
            .main-grid {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
            }

            .video-container {
                width: 100% !important;
                max-width: 500px;
                margin: 0 auto;
            }

            #camera-stream {
                width: 100% !important;
                max-width: 500px !important;
                height: auto !important;
            }

            #detection-canvas {
                width: 100% !important;
                max-width: 500px !important;
                height: auto !important;
            }
        }

        @media (max-width: 768px) {

            /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tablet ‡πÅ‡∏•‡∏∞ mobile */
            main {
                padding: 1rem !important;
            }

            .main-grid {
                gap: 1rem !important;
            }

            .video-container {
                width: 100% !important;
                max-width: 100%;
                margin: 0;
            }

            #camera-stream {
                width: 100% !important;
                height: auto !important;
            }

            #detection-canvas {
                width: 100% !important;
                height: auto !important;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ controls */
            .camera-controls button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .space-x-4>*+* {
                margin-left: 0.5rem !important;
            }
        }

        @media (max-width: 640px) {

            /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile ‡πÄ‡∏•‡πá‡∏Å */
            .camera-controls {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            .space-x-4 {
                flex-direction: column !important;
            }

            .space-x-4>*+* {
                margin-left: 0 !important;
                margin-top: 0.5rem !important;
            }

            h1 {
                font-size: 1rem !important;
            }

            h2 {
                font-size: 1.25rem !important;
            }

            h3 {
                font-size: 1.125rem !important;
            }

            /* Responsive table */
            table {
                font-size: 0.75rem !important;
            }

            table th,
            table td {
                padding: 0.25rem !important;
            }

            /* Stack table cells on very small screens */
            @media (max-width: 480px) {

                table,
                thead,
                tbody,
                th,
                td,
                tr {
                    display: block;
                }

                thead tr {
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                }

                tr {
                    border: 1px solid #ccc;
                    margin-bottom: 10px;
                    padding: 10px;
                    border-radius: 5px;
                }

                td {
                    border: none;
                    position: relative;
                    padding-left: 50% !important;
                    text-align: left !important;
                }

                td:before {
                    content: attr(data-label) ": ";
                    position: absolute;
                    left: 6px;
                    width: 45%;
                    white-space: nowrap;
                    font-weight: bold;
                }
            }
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin: -25px 0 0 -25px;
            /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î */
        #camera-off-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 8px;
            z-index: 15;
            display: none;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
        #canvas {
            display: none;
        }

        #detection-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
        }

        .captured-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .captured-image-wrapper {
            position: relative;
            cursor: pointer;
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .captured-image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            margin: 5% auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
        }

        .modal img {
            width: 100%;
            height: auto;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö camera-controls */
        #camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .toggle-wrapper label {
            margin-right: 10px;
            font-weight: bold;
        }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö */
        .detect-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .detect-status.loading {
            background-color: #fff3cd;
            color: #856404;
            display: block;
        }

        .detect-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .detect-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }

        /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dual-stream container */
        .overlay-text {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        #dual-detection-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .detection-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .detection-item:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>

    <script>        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        async function loadCurrentOrder() {
            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!rawToken) return;

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

            try {
                const response = await fetch(`http://192.168.0.44:8001/packing/orders/current`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/current`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch order");

                const orderData = await response.json();

                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
                if (orderData.order_id) {
                    localStorage.setItem("currentOrderId", orderData.order_id);
                    displayOrderDetails(orderData);
                } else {
                    localStorage.removeItem("currentOrderId");  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏•‡∏ö localStorage
                    displayOrderDetails(null);
                }

            } catch (error) {
                console.error("‚ùå Error loading current order:", error.message);
                displayOrderDetails(null);
            }
        }        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡∏¥‡∏î
        document.addEventListener('DOMContentLoaded', () => {
            loadCameraList();
            loadPackingOrders();
            loadCurrentOrder();  // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            stopCameraBtn.disabled = true;
            startDetectionBtn.disabled = true;
            stopDetectionBtn.disabled = true;
            refreshStreamBtn.disabled = true;
        });

        // ‚úÖ Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        window.addEventListener('resize', () => {
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
            setTimeout(() => {
                const detectionCanvas = document.getElementById('detection-canvas');
                const cameraStreamImg = document.getElementById('camera-stream');

                if (detectionCanvas && cameraStreamImg && cameraStreamImg.offsetWidth > 0) {
                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const displayedWidth = cameraStreamImg.offsetWidth;
                    const displayedHeight = cameraStreamImg.offsetHeight;

                    detectionCanvas.width = displayedWidth;
                    detectionCanvas.height = displayedHeight;
                    detectionCanvas.style.width = displayedWidth + 'px';
                    detectionCanvas.style.height = displayedHeight + 'px';

                    console.log(`üì± Canvas resized to: ${displayedWidth}x${displayedHeight}`);
                }
            }, 100);
        });// ...existing code...        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        function checkOrderItemsMatch(detectedItems) {
            console.log('üîç checkOrderItemsMatch called with:', detectedItems);

            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å localStorage
            const currentOrderId = localStorage.getItem("currentOrderId");
            if (!currentOrderId) {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö currentOrderId ‡πÉ‡∏ô localStorage");
                return;
            }

            // ‡∏î‡∏∂‡∏á div ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            const currentOrderDiv = document.getElementById('current-order');
            const orderItemElements = currentOrderDiv.querySelectorAll('li');

            if (!orderItemElements || orderItemElements.length === 0) {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            let orderItemsWithQuantity = {};

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            orderItemElements.forEach(item => {
                const productNameElement = item.querySelector('strong');
                if (!productNameElement) return;

                const productName = productNameElement.textContent.trim();
                // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô "Arduino UNO - 2 ‡∏ä‡∏¥‡πâ‡∏ô")
                const itemText = item.textContent.trim();
                const quantityMatch = itemText.match(/(\d+)\s+‡∏ä‡∏¥‡πâ‡∏ô/);
                const quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;

                orderItemsWithQuantity[productName] = quantity;
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            let allItemsFound = true;
            let foundItems = {};
            let extraItems = {};

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏î‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
            Object.keys(orderItemsWithQuantity).forEach(productName => {
                const orderQuantity = orderItemsWithQuantity[productName];
                let detectedQuantity = 0;

                // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ
                Object.keys(detectedItems).forEach(label => {
                    if (label.toLowerCase().includes(productName.toLowerCase()) ||
                        productName.toLowerCase().includes(label.toLowerCase())) {
                        detectedQuantity = detectedItems[label];
                    }
                });

                if (detectedQuantity === 0) {
                    // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
                    allItemsFound = false;
                } else if (detectedQuantity < orderQuantity) {
                    // ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                    allItemsFound = false;
                    foundItems[productName] = detectedQuantity;
                } else if (detectedQuantity > orderQuantity) {
                    // ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô
                    foundItems[productName] = orderQuantity;
                    extraItems[productName] = detectedQuantity - orderQuantity;
                } else {
                    // ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏≠‡∏î‡∏µ
                    foundItems[productName] = detectedQuantity;
                }
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            Object.keys(detectedItems).forEach(detectedLabel => {
                let isInOrder = false;

                Object.keys(orderItemsWithQuantity).forEach(orderItem => {
                    if (detectedLabel.toLowerCase().includes(orderItem.toLowerCase()) ||
                        orderItem.toLowerCase().includes(detectedLabel.toLowerCase())) {
                        isInOrder = true;
                    }
                });

                if (!isInOrder) {
                    // ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                    extraItems[detectedLabel] = detectedItems[detectedLabel];
                }
            });

            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            const verificationStatus = document.getElementById('verification-status');

            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï DOM
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ã‡πâ‡∏≥
            const now = Date.now();
            const lastUpdateTime = verificationStatus.dataset.lastUpdateTime || 0;
            const updateInterval = 3000; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï DOM ‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï ‡∏Å‡πá‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
            if (now - lastUpdateTime < updateInterval) {
                return;
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï DOM
            verificationStatus.dataset.lastUpdateTime = now;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let extraItemsHtml = '';
            if (Object.keys(extraItems).length > 0) {
                extraItemsHtml = `
                    <div class="mt-4 p-3 bg-yellow-100 border border-yellow-400 rounded-md">
                        <p class="font-bold text-yellow-700">‚ö†Ô∏è ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:</p>
                        <ul class="mt-2 text-yellow-800">
                `;

                Object.keys(extraItems).forEach(item => {
                    extraItemsHtml += `<li>- ${item}: <span class="font-bold">${extraItems[item]} ‡∏ä‡∏¥‡πâ‡∏ô</span></li>`;
                });

                extraItemsHtml += `
                        </ul>
                    </div>
                `;
            } if (allItemsFound && Object.keys(foundItems).length > 0) {
                verificationStatus.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 my-4 rounded-md shadow-sm">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <p class="font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß!</p>
                        </div>
                        <p class="ml-8 text-sm">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</p>
                    </div>
                    ${extraItemsHtml}
                    <div class="flex justify-center mt-4 space-x-4">
                        ${Object.keys(extraItems).length === 0 ?
                        `<button id="confirm-order-btn" onclick="verifyOrderWithDebounce(${currentOrderId}, true)" 
                            class="bg-green-500 text-white px-6 py-3 rounded-md hover:bg-green-600 mr-2 flex items-center justify-center shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö
                        </button>` :
                        `<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 p-3 rounded-md">
                            <p class="font-bold flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ
                            </p>
                        </div>`}
                        <button id="reject-order-btn" onclick="verifyOrderWithDebounce(${currentOrderId}, false)"
                            class="bg-red-500 text-white px-6 py-3 rounded-md hover:bg-red-600 flex items-center justify-center shadow-md transition duration-200 ease-in-out transform hover:scale-105"
                            title="‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                        </button>
                    </div>
                `;
                verificationStatus.style.display = "block";
            } else if (Object.keys(detectedItems).length > 0) {
                verificationStatus.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-400 text-red-700 p-4 my-4 rounded-md shadow-sm">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-bold">‡∏¢‡∏±‡∏á‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå!</p>
                        </div>
                        <p class="ml-8 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                    </div>
                    ${extraItemsHtml}
                    <div class="flex justify-center mt-4">                        <button id="reject-incomplete-btn" onclick="verifyOrderWithDebounce(${currentOrderId}, false)"
                            class="bg-yellow-500 text-white px-6 py-3 rounded-md hover:bg-yellow-600 flex items-center justify-center shadow-md transition duration-200 ease-in-out transform hover:scale-105"
                            title="‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                        </button>
                    </div>
                `;
                verificationStatus.style.display = "block";
            } else {
                // ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô verification status ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                verificationStatus.innerHTML = '';
                verificationStatus.style.display = "none";
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        function displayDetections(detections) {
            const detectionList = document.getElementById('detection-list');
            detectionList.innerHTML = '';

            if (!detections || detections.length === 0) {
                detectionList.innerHTML = '<div class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÉ‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏û</div>';
                return;
            }

            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            const counts = {};
            detections.forEach(detection => {
                const label = detection.label;
                counts[label] = (counts[label] || 0) + 1;
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            for (const [label, count] of Object.entries(counts)) {
                const item = document.createElement('div');
                item.className = 'py-2 border-b';
                item.innerHTML = `<span class="font-bold">${label}</span>: <span class="text-blue-600">${count} ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
                detectionList.appendChild(item);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏ï‡∏£‡∏µ‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        function openDirectRealtimeDetection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô");
                return;
            }

            if (!currentCamera) {
                alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô");
                return;
            }

            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏ï‡∏£‡∏µ‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const directUrl = `http://192.168.0.44:8001/packing/realtime-detect-direct?camera_id=${currentCamera.id}&token=${token}`;
            window.open(directUrl, '_blank', 'width=680,height=520');
        }        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å DB
        async function loadCameraList() {
            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken ? rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '') : null;
            try {
                const response = await fetch('http://192.168.0.44:8001/packing/cameras', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/cameras', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching cameras: ${response.status}`);
                }
                const cameras = await response.json();
                // Populate dropdown
                cameraDropdown.innerHTML = '';
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.textContent = `‡∏Å‡∏•‡πâ‡∏≠‡∏á ${camera.name}`;
                    option.dataset.streamUrl = camera.stream_url;
                    cameraDropdown.appendChild(option);
                });
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (cameras.length > 0) {
                    currentCamera = cameras[0];
                    cameraDropdown.value = currentCamera.id;
                    startCameraBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);
            }
        } async function verifyOrder(orderId, isVerified) {
            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!rawToken) {
                alert("‚ùå No Authorization Token Found");
                return;
            }

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

            const formData = new FormData();
            formData.append("verified", isVerified);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ dual-stream ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const rawStreamImg = document.getElementById('raw-stream');
            const capturedImage = document.getElementById('captured-image');
            let imageBlob = null;

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å dual-stream ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
            if (window.dualStreamWS && rawStreamImg.src && rawStreamImg.src.startsWith('data:image/jpeg;base64,')) {
                try {
                    // ‡πÅ‡∏õ‡∏•‡∏á data URL ‡πÄ‡∏õ‡πá‡∏ô Blob
                    const base64Data = rawStreamImg.src.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    imageBlob = new Blob([byteArray], { type: 'image/jpeg' });
                    console.log("‚úÖ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å dual-stream");
                } catch (e) {
                    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û dual-stream:", e);
                }
            }
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            else if (capturedImage.src && capturedImage.src.startsWith("blob")) {
                try {
                    const response = await fetch(capturedImage.src);
                    imageBlob = await response.blob();
                    console.log("‚úÖ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                } catch (e) {
                    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢:", e);
                }
            }            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
            if (imageBlob) {
                formData.append("file", imageBlob, "verify_image.jpg");
            } else {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏≠‡∏á");
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° camera_id ‡∏•‡∏á‡πÉ‡∏ô formData ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
            if (currentCamera) {
                formData.append("camera_id", currentCamera.id);
                console.log(`‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á ID: ${currentCamera.id}`);
            } else {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á");
            }

            try {
                console.log("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...");
                const response = await fetch(`http://192.168.0.44:8001/packing/orders/${orderId}/verify`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/verify`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° header ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ dual-stream
                        "X-Source-Page": "packing_dashboard_dual_stream"
                    },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail);
                }

                alert(result.message);

                // FIXME: ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏Ñ‡πà 
                // üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing ‡πÅ‡∏•‡∏∞ üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏
                window.location.reload();
            } catch (error) {
                alert("‚ùå " + error.message);
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debounce ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥‡πÜ ‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ô‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
        let verifyOrderDebounceTimer;

        function verifyOrderWithDebounce(orderId, isVerified) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            if (verifyOrderDebounceTimer) {
                console.log("üõë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
                return;
            }

            // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            const confirmBtn = document.getElementById('confirm-order-btn');
            const rejectBtn = document.getElementById('reject-order-btn');
            const rejectIncompleteBtn = document.getElementById('reject-incomplete-btn');

            // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            if (confirmBtn) confirmBtn.disabled = true;
            if (rejectBtn) rejectBtn.disabled = true;
            if (rejectIncompleteBtn) rejectIncompleteBtn.disabled = true;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            if (confirmBtn) confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            if (rejectBtn) rejectBtn.classList.add('opacity-50', 'cursor-not-allowed');
            if (rejectIncompleteBtn) rejectIncompleteBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
            verifyOrderDebounceTimer = setTimeout(() => {
                verifyOrder(orderId, isVerified);

                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if (rejectBtn) {
                    rejectBtn.disabled = false;
                    rejectBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if (rejectIncompleteBtn) {
                    rejectIncompleteBtn.disabled = false;
                    rejectIncompleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                verifyOrderDebounceTimer = null;
            }, 1500); // ‡∏£‡∏≠ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
        }        // ‚úÖ Helper function to wait for image loading with promise
        function waitForImageLoad(img) {
            return new Promise((resolve, reject) => {
                if (img.complete && img.naturalHeight !== 0) {
                    resolve(img);
                    return;
                }

                img.onload = () => {
                    console.log(`‚úÖ Image loaded successfully: ${img.src}`);
                    resolve(img);
                };

                img.onerror = () => {
                    console.warn(`‚ö†Ô∏è Image failed to load: ${img.src}`);
                    reject(new Error(`Failed to load image: ${img.src}`));
                };
            });
        }
        // ‚úÖ Helper function to wait for image loading completion
        function waitForImageLoad(img) {
            return new Promise((resolve, reject) => {
                if (img.complete && img.naturalHeight !== 0) {
                    resolve(img);
                } else {
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error(`Failed to load image: ${img.src}`));
                }
            });
        }

        // ‚úÖ Helper function to create image element with proper error handling and fallback
        async function createImageElement(imagePath, altText) {
            return new Promise(async (resolve) => {
                console.log(`üñºÔ∏è Attempting to load image: ${imagePath}`);

                const img = document.createElement('img');
                img.alt = altText;
                img.loading = 'eager';
                img.className = 'w-full h-full object-contain border rounded-md shadow-sm';

                // Set timeout for loading
                const timeout = setTimeout(() => {
                    console.warn(`‚è∞ Image loading timeout: ${imagePath}`);
                    const fallback = document.createElement('div');
                    fallback.className = 'w-full h-full bg-gray-200 flex items-center justify-center rounded-md text-xs text-gray-500 border';
                    fallback.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ';
                    resolve(fallback);
                }, 5000); // 5 second timeout

                img.onload = () => {
                    clearTimeout(timeout);
                    console.log(`‚úÖ Image loaded successfully: ${imagePath}`);
                    resolve(img);
                };

                img.onerror = () => {
                    clearTimeout(timeout);
                    console.warn(`‚ùå Image failed to load: ${imagePath}`);
                    const fallback = document.createElement('div');
                    fallback.className = 'w-full h-full bg-gray-200 flex items-center justify-center rounded-md text-xs text-gray-500 border';
                    fallback.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ';
                    resolve(fallback);
                };

                // Start loading the image
                img.src = imagePath;
            });
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ - Enhanced image loading with proper async handling
        async function displayOrderDetails(orderData) {
            const currentOrderDiv = document.getElementById('current-order');

            if (!orderData) {
                currentOrderDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</p>';
                return;
            }

            console.log(`üèóÔ∏è Building order display for Order ID: ${orderData.order_id}`);

            // Clear existing content
            currentOrderDiv.innerHTML = '';

            // Create main container
            const mainContainer = document.createElement('div');
            mainContainer.className = 'p-4 border rounded-md bg-gray-100 shadow-sm';

            // Create order info section
            const orderInfoDiv = document.createElement('div');
            orderInfoDiv.className = 'mb-3 bg-white p-3 rounded-md shadow-sm';
            orderInfoDiv.innerHTML = `
                <p><strong>üÜî Order ID:</strong> <span class="ml-2 text-blue-600">${orderData.order_id}</span></p>
                <p><strong>üìß ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> <span class="ml-2 text-gray-700">${orderData.customer_email}</span></p>
                <p><strong>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</strong> <span class="ml-2 text-green-600 font-semibold">‡∏ø${orderData.total_price}</span></p>
                <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span class="ml-2 text-gray-700">${orderData.created_at}</span></p>
                ${orderData.camera_id ? `<p><strong>üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à:</strong> <span class="ml-2 text-purple-600">‡∏Å‡∏•‡πâ‡∏≠‡∏á #${orderData.camera_id}</span></p>` : ''}
            `;

            // Create header section
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between mt-4 mb-2';

            const titleDiv = document.createElement('h4');
            titleDiv.className = 'text-lg font-bold flex items-center';
            titleDiv.innerHTML = `
                <span class="mr-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                <span class="text-sm font-normal text-gray-500">(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
            `;

            const cancelButton = document.createElement('button');
            cancelButton.className = 'mt-2 sm:mt-0 bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 flex items-center justify-center shadow-md transition duration-200 ease-in-out transform hover:scale-105';
            cancelButton.title = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ';
            cancelButton.onclick = () => cancelOrderAssignment(orderData.order_id);
            cancelButton.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            `;

            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(cancelButton);

            // Create items list
            const itemsList = document.createElement('ul');
            itemsList.className = 'mt-2 bg-white rounded-md shadow-sm p-2 divide-y divide-gray-100';

            // Process each item with proper DOM creation and async image handling
            console.log(`üì¶ Processing ${orderData.items.length} items...`);

            for (const item of orderData.items) {
                const listItem = document.createElement('li');
                listItem.className = 'border-b py-2 flex items-center';

                // Create image container
                const imageContainer = document.createElement('div');
                imageContainer.className = 'w-16 h-16 mr-3 flex-shrink-0';

                console.log(`üñºÔ∏è Processing image for ${item.product_name}:`, item.image_path);

                if (item.image_path && item.image_path.trim() !== '') {
                    try {
                        // Use the enhanced createImageElement function with proper async handling
                        const imageElement = await createImageElement(item.image_path, item.product_name);
                        imageContainer.appendChild(imageElement);
                        console.log(`‚úÖ Successfully added image for ${item.product_name}`);
                    } catch (error) {
                        console.error(`‚ùå Error loading image for ${item.product_name}:`, error);
                        // Create fallback element in case of error
                        const placeholderElement = document.createElement('div');
                        placeholderElement.className = 'w-full h-full bg-gray-200 flex items-center justify-center rounded-md text-xs text-gray-500 border';
                        placeholderElement.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ';
                        imageContainer.appendChild(placeholderElement);
                    }
                } else {
                    // No image path - show placeholder
                    console.log(`‚ÑπÔ∏è No image path for ${item.product_name}, showing placeholder`);
                    const placeholderElement = document.createElement('div');
                    placeholderElement.className = 'w-full h-full bg-gray-200 flex items-center justify-center rounded-md text-xs text-gray-500 border';
                    placeholderElement.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ';
                    imageContainer.appendChild(placeholderElement);
                }

                // Create text content
                const textContainer = document.createElement('div');
                textContainer.className = 'flex-grow';
                textContainer.innerHTML = `<strong>${item.product_name}</strong> - ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`;

                listItem.appendChild(imageContainer);
                listItem.appendChild(textContainer);
                itemsList.appendChild(listItem);
            }

            // Assemble the complete structure
            mainContainer.appendChild(orderInfoDiv);
            mainContainer.appendChild(headerDiv);
            mainContainer.appendChild(itemsList);
            currentOrderDiv.appendChild(mainContainer);

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å orderId ‡∏•‡∏á‡πÉ‡∏ô localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkOrderItemsMatch
            localStorage.setItem("currentOrderId", orderData.order_id);

            console.log(`‚úÖ Successfully displayed order ${orderData.order_id} with ${orderData.items.length} items and proper image loading`);
        }// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
        async function startDetection() {
            try {
                const rawToken = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!rawToken) {
                    throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
                }

                // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
                const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

                if (!currentCamera) {
                    throw new Error('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                }

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                startDetectionBtn.disabled = true;
                stopDetectionBtn.disabled = false;
                isDetecting = true;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('detect-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏...';
                document.getElementById('detect-status').className = 'detect-status loading';

                // ‡πÅ‡∏™‡∏î‡∏á detection results
                document.getElementById('detection-results').style.display = 'block';

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                detectionInterval = setInterval(async () => {
                    if (!isDetecting) return;

                    try {
                        await performDetection();
                    } catch (error) {
                        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö:', error.message);
                    }
                }, 2000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

                console.log('‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö: ' + error.message);

                startDetectionBtn.disabled = false;
                stopDetectionBtn.disabled = true;
                isDetecting = false;
            }
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
        async function stopDetection() {
            try {
                // ‡∏´‡∏¢‡∏∏‡∏î interval
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }

                isDetecting = false;

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                startDetectionBtn.disabled = false;
                stopDetectionBtn.disabled = true;

                // ‡∏•‡πâ‡∏≤‡∏á canvas - ‡∏•‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
                const detectionCanvas = document.getElementById('detection-canvas');
                const canvasCtx = detectionCanvas.getContext('2d');
                canvasCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

                // ‡∏ã‡πà‡∏≠‡∏ô detection results
                document.getElementById('detection-results').style.display = 'none';
                document.getElementById('verification-status').style.display = 'none';

                // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                const detectionList = document.getElementById('detection-list');
                detectionList.innerHTML = '';

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('detect-status').textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                document.getElementById('detect-status').className = 'detect-status';

                console.log('‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á canvas ‡πÅ‡∏•‡πâ‡∏ß');

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö:', error.message);
            }
        }// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        async function performDetection() {
            try {
                const rawToken = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!rawToken || !currentCamera) return;

                // ‡πÅ‡∏¢‡∏á JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
                const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const currentOrderId = localStorage.getItem("currentOrderId");
                if (!currentOrderId) {
                    console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö currentOrderId");
                    return;
                }                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
                const response = await fetch('http://192.168.0.44:8001/packing/detect-from-camera', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        camera_id: currentCamera.id,
                        order_id: parseInt(currentOrderId)
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const result = await response.json();

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                displayDetectionResults(result);

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö:', error.message);
            }
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        function displayDetectionResults(result) {
            // ‡∏•‡πâ‡∏≤‡∏á canvas ‡∏Å‡πà‡∏≠‡∏ô - ‡∏•‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            const detectionCanvas = document.getElementById('detection-canvas');
            const canvasCtx = detectionCanvas.getContext('2d');
            canvasCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
            const detectionList = document.getElementById('detection-list');
            detectionList.innerHTML = ''; if (!result.detections || result.detections.length === 0) {
                detectionList.innerHTML = '<div class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÉ‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏û</div>';
                // ‡∏•‡πâ‡∏≤‡∏á canvas ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡∏∞ return
                canvasCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                // ‡∏ã‡πà‡∏≠‡∏ô verification status ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                const verificationStatus = document.getElementById('verification-status');
                verificationStatus.innerHTML = '';
                verificationStatus.style.display = 'none';

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkOrderItemsMatch ‡∏î‡πâ‡∏ß‡∏¢ object ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ verification status ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô
                checkOrderItemsMatch({});
                return;
            }// ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ confidence threshold ‡∏à‡∏≤‡∏Å UI slider
            const confidenceThreshold = parseFloat(document.getElementById('confidence-threshold').value);

            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏µ confidence ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            const filteredDetections = result.detections.filter(detection => detection.confidence > confidenceThreshold);

            console.log(`üìä Detection Results stats: Total: ${result.detections.length}, High confidence (>${confidenceThreshold}): ${filteredDetections.length}`);            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå confidence ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (filteredDetections.length === 0) {
                detectionList.innerHTML = `<div class="detection-item text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô > ${(confidenceThreshold * 100).toFixed(0)}%</div>`;
                // ‡∏ã‡πà‡∏≠‡∏ô verification status ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå confidence
                const verificationStatus = document.getElementById('verification-status');
                verificationStatus.innerHTML = '';
                verificationStatus.style.display = 'none';

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkOrderItemsMatch ‡∏î‡πâ‡∏ß‡∏¢ object ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ verification status ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô
                checkOrderItemsMatch({});
                return;
            }

            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
            const counts = {};
            filteredDetections.forEach(detection => {
                const label = detection.label;
                counts[label] = (counts[label] || 0) + 1;
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            for (const [label, count] of Object.entries(counts)) {
                const item = document.createElement('div');
                item.className = 'detection-item';

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const isInOrder = result.in_order_items && result.in_order_items.includes(label);
                const color = isInOrder ? 'text-green-600' : 'text-red-600';
                const icon = isInOrder ? '‚úÖ' : '‚ùå';

                item.innerHTML = `
                    <span class="font-bold">${icon} ${label}</span> 
                    <span class="${color}">${count} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                `;
                detectionList.appendChild(item);
            }

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ö‡∏ô canvas (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
            drawDetectionBoxes(filteredDetections, result.in_order_items || []);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÉ‡∏ä‡πâ counts ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
            checkOrderItemsMatch(counts);
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        function drawDetectionBoxes(detections, inOrderItems) {
            const cameraStreamImg = document.getElementById('camera-stream');
            const detectionCanvas = document.getElementById('detection-canvas');
            const canvasCtx = detectionCanvas.getContext('2d');

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏£‡∏¥‡∏á
            const displayedWidth = cameraStreamImg.offsetWidth;
            const displayedHeight = cameraStreamImg.offsetHeight;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            detectionCanvas.width = displayedWidth;
            detectionCanvas.height = displayedHeight;

            // ‡∏õ‡∏£‡∏±‡∏ö style ‡∏Ç‡∏≠‡∏á canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
            detectionCanvas.style.width = displayedWidth + 'px';
            detectionCanvas.style.height = displayedHeight + 'px';

            const imgWidth = cameraStreamImg.naturalWidth || 640;
            const imgHeight = cameraStreamImg.naturalHeight || 480;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
            const scaleX = displayedWidth / imgWidth;
            const scaleY = displayedHeight / imgHeight;

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ confidence threshold ‡πÅ‡∏•‡πâ‡∏ß
            console.log(`üìä Drawing ${detections.length} filtered detections on canvas (${displayedWidth}x${displayedHeight})`);

            detections.forEach(detection => {
                const [x1, y1, x2, y2] = detection.box;

                // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô canvas ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏£‡∏¥‡∏á
                const scaledX1 = x1 * scaleX;
                const scaledY1 = y1 * scaleY;
                const scaledX2 = x2 * scaleX;
                const scaledY2 = y2 * scaleY;

                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
                const isInOrder = inOrderItems.includes(detection.label);
                const color = isInOrder ? '#00ff00' : '#ff0000'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå

                // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
                canvasCtx.strokeStyle = color;
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeRect(scaledX1, scaledY1, scaledX2 - scaledX1, scaledY2 - scaledY1);

                // ‡∏ß‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                const label = `${detection.label}: ${(detection.confidence * 100).toFixed(1)}%`;
                canvasCtx.fillStyle = color;
                canvasCtx.font = '16px Arial';

                // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                const textMetrics = canvasCtx.measureText(label);
                const textHeight = 20;
                canvasCtx.fillRect(scaledX1, scaledY1 - textHeight, textMetrics.width + 10, textHeight);

                // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                canvasCtx.fillStyle = '#000000'; canvasCtx.fillText(label, scaledX1 + 5, scaledY1 - 5);
            });
        }
    </script>
</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-md p-4">
        <div class="max-w-screen-xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-lg lg:text-xl font-bold mb-2 sm:mb-0">üì∑ Packing Staff Camera Dashboard (YOLOv10)</h1>
            <a href="/" class="text-blue-500 hover:underline text-sm lg:text-base">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>
    </nav>
    <main class="p-4 lg:p-8">
        <div class="main-grid grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8">
            <!-- Left Column - Camera and Detection -->
            <div class="space-y-6"> <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) -->
                <div class="mb-4 text-center">
                    <label for="camera-dropdown" class="block mb-2 text-base lg:text-lg font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
                        (‡πÇ‡∏ï‡πä‡∏∞):</label>
                    <select id="camera-dropdown" class="border border-gray-300 rounded-md p-2 w-full max-w-xs">
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å populate ‡πÇ‡∏î‡∏¢ JavaScript -->
                    </select>
                </div>

                <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 text-center lg:text-left">üîç
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ YOLOv10 ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á</h2>

                <!-- Control panel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö -->
                <div id="detect-status" class="detect-status" style="display: none;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                </div> <!-- Camera Stream Container -->
                <div id="camera-stream-container" class="text-center" style="display: none;">
                    <div class="video-container"
                        style="position: relative; width: 100%; max-width: 640px; margin: 0 auto;">
                        <img id="camera-stream"
                            style="width: 100%; max-width: 640px; height: auto; object-fit: contain; border: 2px solid #3498db; border-radius: 8px; display: block;">
                        <canvas id="detection-canvas" width="640" height="480"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border-radius: 8px;"></canvas>
                        <div class="overlay-text">Camera Stream</div>

                        <!-- Loading Spinner for camera -->
                        <div id="camera-loading-spinner"
                            style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center space-x-2 lg:space-x-4 mb-4">
                    <!-- Confidence Threshold Control -->
                    <div class="flex items-center space-x-2 bg-gray-200 px-2 py-1 lg:px-3 lg:py-2 rounded-md">
                        <label for="confidence-threshold" class="text-xs lg:text-sm font-medium">üéØ Confidence:</label>
                        <input type="range" id="confidence-threshold" min="0.1" max="1.0" step="0.05" value="0.7"
                            class="w-16 lg:w-20 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        <span id="confidence-value" class="text-xs lg:text-sm font-bold">0.7</span>
                    </div>
                </div>
                <div class="camera-controls flex flex-wrap justify-center space-x-2 lg:space-x-4 mb-4">
                    <button id="start-camera"
                        class="bg-green-500 text-white px-3 py-2 lg:px-4 lg:py-2 rounded-md hover:bg-green-600 text-sm lg:text-base"
                        disabled>üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button id="stop-camera"
                        class="bg-red-500 text-white px-3 py-2 lg:px-4 lg:py-2 rounded-md hover:bg-red-600 text-sm lg:text-base"
                        disabled>üõë
                        ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button id="start-detection"
                        class="bg-purple-500 text-white px-3 py-2 lg:px-4 lg:py-2 rounded-md hover:bg-purple-600 text-sm lg:text-base"
                        disabled>üîç
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</button>
                    <button id="stop-detection"
                        class="bg-orange-500 text-white px-3 py-2 lg:px-4 lg:py-2 rounded-md hover:bg-orange-600 text-sm lg:text-base"
                        disabled>‚èπÔ∏è
                        ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</button>
                    <button id="refresh-stream"
                        class="bg-blue-500 text-white px-3 py-2 lg:px-4 lg:py-2 rounded-md hover:bg-blue-600 text-sm lg:text-base"
                        disabled>
                        <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏•‡πâ‡∏≠‡∏á
                    </button>
                </div>

                <!-- Camera Controls -->
                <div id="camera-controls" class="mb-4">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
                </div>
            </div> <!-- Right Column - Order Details -->
            <div class="space-y-4 lg:space-y-6">
                <section>
                    <h3 class="text-xl lg:text-2xl font-bold mb-3 lg:mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</h3>
                    <div id="current-order" class="bg-white shadow-md p-3 lg:p-4 rounded-md">
                        <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</p>
                    </div>
                </section> <!-- Detection Results -->
                <div id="detection-results"
                    style="display: none; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <h3 class="text-lg lg:text-xl font-bold mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏</h3>
                    <div id="detection-list"></div>
                </div>

                <!-- Verification Status -->
                <div id="verification-status" style="display: none;"></div>
            </div>
        </div>
        <!-- Bottom Section - Packing Orders List -->
        <section class="mt-6 lg:mt-8 text-center">
            <h3 class="text-xl lg:text-2xl font-bold mb-3 lg:mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</h3>
            <div id="packing-orders-list" class="bg-white shadow-md p-3 lg:p-4 rounded-md overflow-x-auto">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </section>
    </main>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢ -->
    <div id="image-modal" class="modal">
        <span class="close" id="close-modal">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <canvas id="canvas"></canvas>

    <script>        const canvas = document.getElementById('detection-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const detectionList = document.getElementById('detection-list');

        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const startDetectionBtn = document.getElementById('start-detection');
        const stopDetectionBtn = document.getElementById('stop-detection');
        const refreshStreamBtn = document.getElementById('refresh-stream');

        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const closeModal = document.getElementById('close-modal');
        const cameraDropdown = document.getElementById('camera-dropdown');
        const packingOrdersList = document.getElementById('packing-orders-list');

        let currentCamera = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let cameraStream = null; // ‡πÄ‡∏Å‡πá‡∏ö stream ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
        let detectionInterval = null; // ‡πÄ‡∏Å‡πá‡∏ö interval ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        let isDetecting = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        refreshStreamBtn.addEventListener('click', refreshCameraStream);        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° camera stream
        async function startCameraStream() {
            try {
                const rawToken = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!rawToken) {
                    throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
                }

                // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
                const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

                if (!currentCamera) {
                    throw new Error('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                }

                // ‡πÅ‡∏™‡∏î‡∏á loading spinner
                document.getElementById('camera-loading-spinner').style.display = 'block';                // ‡πÄ‡∏õ‡∏¥‡∏î camera stream
                const streamUrl = `http://192.168.0.44:8001/packing/stream?camera_id=${currentCamera.id}&token=${token}`;
                const cameraStreamImg = document.getElementById('camera-stream');
                cameraStreamImg.src = streamUrl;

                // ‡πÅ‡∏™‡∏î‡∏á container
                document.getElementById('camera-stream-container').style.display = 'block';

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                startDetectionBtn.disabled = false;
                refreshStreamBtn.disabled = false;

                // ‡∏ã‡πà‡∏≠‡∏ô loading spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠ stream ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                cameraStreamImg.onload = () => {
                    document.getElementById('camera-loading-spinner').style.display = 'none';
                };

                console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                document.getElementById('detect-status').textContent = '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                document.getElementById('detect-status').className = 'detect-status success';

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);

                // ‡∏ã‡πà‡∏≠‡∏ô loading spinner
                document.getElementById('camera-loading-spinner').style.display = 'none';
                startCameraBtn.disabled = false;
            }
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î camera stream
        async function stopCameraStream() {
            try {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô
                if (isDetecting) {
                    await stopDetection();
                }

                // ‡∏õ‡∏¥‡∏î camera stream
                const cameraStreamImg = document.getElementById('camera-stream');
                cameraStreamImg.src = '';

                // ‡∏ã‡πà‡∏≠‡∏ô container
                document.getElementById('camera-stream-container').style.display = 'none';

                // ‡∏•‡πâ‡∏≤‡∏á canvas - ‡∏•‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
                const detectionCanvas = document.getElementById('detection-canvas');
                const canvasCtx = detectionCanvas.getContext('2d');
                canvasCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                startDetectionBtn.disabled = true;
                stopDetectionBtn.disabled = true;
                refreshStreamBtn.disabled = true;

                console.log('‚úÖ ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á canvas ‡πÅ‡∏•‡πâ‡∏ß');
                document.getElementById('detect-status').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö';
                document.getElementById('detect-status').className = 'detect-status';

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);
            }
        }        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä camera stream
        async function refreshCameraStream() {
            try {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                refreshStreamBtn.disabled = true;

                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä stream ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ src ‡πÉ‡∏´‡∏°‡πà
                const cameraStreamImg = document.getElementById('camera-stream');

                // ‡πÅ‡∏¢‡∏Å base URL ‡πÅ‡∏•‡∏∞ token parameter
                let currentSrc = cameraStreamImg.src;
                let baseUrl = currentSrc.split('?')[0];  // ‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô URL ‡∏´‡∏•‡∏±‡∏Å
                let tokenParam = currentSrc.split('?')[1]; // ‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô token parameter

                // ‡∏•‡∏ö timestamp ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å token parameter ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (tokenParam && tokenParam.includes('&t=')) {
                    tokenParam = tokenParam.split('&t=')[0];
                }

                cameraStreamImg.src = '';

                // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
                await new Promise(resolve => setTimeout(resolve, 500));

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ src ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ fragment identifier ‡πÅ‡∏ó‡∏ô query parameter
                cameraStreamImg.src = baseUrl + '?' + tokenParam + '#' + Date.now();

                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                setTimeout(() => {
                    refreshStreamBtn.disabled = false;
                }, 2000);

                console.log('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);
                refreshStreamBtn.disabled = false;
            }
        }// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å dropdown ‡πÉ‡∏´‡πâ update ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        cameraDropdown.addEventListener('change', (e) => {
            const selectedOption = cameraDropdown.options[cameraDropdown.selectedIndex];
            currentCamera = {
                id: selectedOption.value,
                stream_url: selectedOption.dataset.streamUrl,
                table_number: selectedOption.textContent
            };
            startCameraBtn.disabled = false;
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        startCameraBtn.addEventListener('click', startCameraStream);
        stopCameraBtn.addEventListener('click', stopCameraStream);
        startDetectionBtn.addEventListener('click', startDetection);
        stopDetectionBtn.addEventListener('click', stopDetection);        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ packing
        async function loadPackingOrders() {
            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken ? rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '') : null;
            try {
                const response = await fetch('http://192.168.0.44:8001/packing/orders/packing', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/orders/packing', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching packing orders: ${response.status}`);
                }
                const orders = await response.json();
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = '';
                if (orders.length === 0) {
                    packingOrdersList.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</p>';
                    return;
                }
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-center border-collapse border border-gray-200';
                table.innerHTML = `
                    <thead>
                      <tr class="bg-gray-200 text-gray-600 uppercase text-xs font-semibold">
                        <th class="py-2 px-3 border">Order ID</th>
                        <th class="py-2 px-3 border">Email</th>
                        <th class="py-2 px-3 border">Total</th>
                        <th class="py-2 px-3 border">Date</th>
                        <th class="py-2 px-3 border">Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á cell ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                    let actionCell = '';
                    if (order.assigned_to === null) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å assign ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô"
                        actionCell = `<button onclick="claimOrder(${order.id})" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤ already assigned (‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà assign ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                        actionCell = `<span class="text-green-600 font-semibold">In Progress</span>`;
                    }
                    tr.innerHTML = `
                        <td class="py-2 px-3 border">${order.id}</td>
                        <td class="py-2 px-3 border">${order.email}</td>
                        <td class="py-2 px-3 border">‡∏ø${order.total}</td>
                        <td class="py-2 px-3 border">${new Date(order.created_at).toLocaleDateString()}</td>
                        <td class="py-2 px-3 border">${actionCell}</td>
                    `;
                    tbody.appendChild(tr);
                });
                packingOrdersList.appendChild(table);
            } catch (error) {
                console.error(error);
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            }
        }        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Claim Order)
        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        async function claimOrder(orderId) {
            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!rawToken) {
                alert("‚ùå No Authorization Token Found");
                return;
            }

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

            try {
                const response = await fetch(`http://192.168.0.44:8001/packing/orders/${orderId}/assign`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to assign order");
                }

                const orderData = await response.json();
                alert(`üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${orderData.order_id} ‡πÅ‡∏•‡πâ‡∏ß!`);

                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏ß‡πâ
                displayOrderDetails(orderData);

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                loadPackingOrders();

            } catch (error) {
                console.error("‚ùå Error claiming order:", error.message);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: " + error.message);
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        async function cancelOrderAssignment(orderId) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            const confirmed = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");

            if (!confirmed) {
                return; // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            }

            const rawToken = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!rawToken) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô");
                return;
            }

            // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
            const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

            try {
                const response = await fetch(`http://192.168.0.44:8001/packing/orders/${orderId}/cancel-assignment`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/cancel-assignment`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to cancel order assignment");
                }

                const result = await response.json();
                alert(`‚úÖ ${result.message}`);

                // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                localStorage.removeItem("currentOrderId");
                displayOrderDetails(null);

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                loadPackingOrders();

            } catch (error) {
                console.error("‚ùå Error canceling order assignment:", error.message);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: " + error.message);
            }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        startCameraBtn.addEventListener('click', async () => {
            try {
                const rawToken = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!rawToken) {
                    throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
                }

                // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
                const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');

                if (!currentCamera) {
                    throw new Error('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                }                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                document.getElementById('refresh-stream').disabled = false;

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° camera stream ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                await startCameraStream();

                console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);
                startCameraBtn.disabled = false;
            }
        });        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        stopCameraBtn.addEventListener('click', async () => {
            try {
                const rawToken = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!rawToken) {
                    throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
                }

                // ‡πÅ‡∏¢‡∏Å JWT token ‡∏à‡∏≤‡∏Å "Bearer " prefix ‡πÅ‡∏•‡∏∞ quotes
                const token = rawToken.replace(/^"?Bearer\s+/, '').replace(/"/g, '');// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î camera stream ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                await stopCameraStream();

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                document.getElementById('refresh-stream').disabled = true;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                document.getElementById('detect-status').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö';
                document.getElementById('detect-status').className = 'detect-status'; console.log('‚úÖ ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á:', error.message);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + error.message);
            }
        });

        // ‚úÖ Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Confidence Threshold Slider
        const confidenceSlider = document.getElementById('confidence-threshold');
        const confidenceValue = document.getElementById('confidence-value');

        confidenceSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value).toFixed(1);
            confidenceValue.textContent = value;
            console.log(`üéØ Confidence threshold updated to: ${value}`);
        });
    </script>
</body>

</html>