<!-- # app/templates/packing_dashboard.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Staff Camera Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <style>
        /* Container wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö video stream, spinner ‡πÅ‡∏•‡∏∞ overlay */
        .video-container {
            position: relative;
            display: inline-block;
            border: 3px solid #3498db;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 15px;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û stream */
        #stream {
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 640px;
            height: 480px;
            display: block;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin: -25px 0 0 -25px;
            /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î */
        #camera-off-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 8px;
            z-index: 15;
            display: none;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
        #canvas {
            display: none;
        }

        /* ‚úÖ Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö object detection overlay */
        #detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            z-index: 5;
            pointer-events: none;
            /* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á video ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        }

        #detection-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
        }

        .captured-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .captured-image-wrapper {
            position: relative;
            cursor: pointer;
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .captured-image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            margin: 5% auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
        }

        .modal img {
            width: 100%;
            height: auto;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö camera-controls */
        #camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .toggle-wrapper label {
            margin-right: 10px;
            font-weight: bold;
        }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• */
        .model-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .model-status.loading {
            background-color: #fff3cd;
            color: #856404;
            display: block;
        }

        .model-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .model-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>

    <script>
        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        async function loadCurrentOrder() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) return;

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/current`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/current`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch order");

                const orderData = await response.json();

                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
                if (orderData.order_id) {
                    localStorage.setItem("currentOrderId", orderData.order_id);
                    displayOrderDetails(orderData);
                } else {
                    localStorage.removeItem("currentOrderId");  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏•‡∏ö localStorage
                    displayOrderDetails(null);
                }

            } catch (error) {
                console.error("‚ùå Error loading current order:", error.message);
                displayOrderDetails(null);
            }
        }


        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡∏¥‡∏î
        document.addEventListener('DOMContentLoaded', () => {
            loadCameraList();
            loadPackingOrders();
            loadCurrentOrder();  // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á video container ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
            const videoContainer = document.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'inline-block';
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ toggle switches
            setupToggleSwitches();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ toggle switches
        function setupToggleSwitches() {
            // ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö switch ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö realtime
            const detectSwitch = document.getElementById('realtime-detection-switch');
            if (detectSwitch) {
                detectSwitch.addEventListener('change', function () {
                    if (this.checked) {
                        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö realtime
                        startRealtimeDetection();
                    } else {
                        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö realtime
                        stopRealtimeDetection();
                    }
                });
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö realtime
        function startRealtimeDetection() {
            if (!window.yoloDetector) {
                document.getElementById('model-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...';
                document.getElementById('model-status').className = 'model-status loading';

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ yoloDetector object ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (typeof YOLODetector === 'undefined') {
                    document.getElementById('model-status').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö YOLODetector object ‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô';
                    document.getElementById('model-status').className = 'model-status error';
                    document.getElementById('realtime-detection-switch').checked = false;
                    return;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á YOLODetector instance ‡πÉ‡∏´‡∏°‡πà
                window.yoloDetector = new YOLODetector();
                const videoElement = document.getElementById('camera-stream');
                const canvasElement = document.getElementById('detection-overlay');

                window.yoloDetector.initialize(videoElement, canvasElement)
                    .then(initialized => {
                        if (initialized) {
                            window.yoloDetector.start();
                            document.getElementById('model-status').textContent = '‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                            document.getElementById('model-status').className = 'model-status success';
                        } else {
                            document.getElementById('model-status').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ';
                            document.getElementById('model-status').className = 'model-status error';
                            document.getElementById('realtime-detection-switch').checked = false;
                        }
                    });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ yoloDetector ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                window.yoloDetector.start();
                document.getElementById('model-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
                document.getElementById('model-status').className = 'model-status success';
            }
        }

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö realtime
        function stopRealtimeDetection() {
            if (window.yoloDetector) {
                window.yoloDetector.stop();
                document.getElementById('model-status').textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                document.getElementById('model-status').className = 'model-status';
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
        async function loadONNXModel() {
            document.getElementById('load-model-btn').disabled = true;
            document.getElementById('model-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX...';
            document.getElementById('model-status').className = 'model-status loading';

            try {
                if (!window.yoloDetector) {
                    window.yoloDetector = new YOLODetector();
                    const videoElement = document.getElementById('camera-stream');
                    const canvasElement = document.getElementById('detection-overlay');

                    const initialized = await window.yoloDetector.initialize(videoElement, canvasElement);

                    if (initialized) {
                        document.getElementById('model-status').textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                        document.getElementById('model-status').className = 'model-status success';
                        document.getElementById('load-model-btn').textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡∏°‡πà';
                    } else {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ');
                    }
                } else {
                    document.getElementById('model-status').textContent = '‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                    document.getElementById('model-status').className = 'model-status success';
                }
            } catch (error) {
                console.error('Error loading ONNX model:', error);
                document.getElementById('model-status').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•: ' + error.message;
                document.getElementById('model-status').className = 'model-status error';
            } finally {
                document.getElementById('load-model-btn').disabled = false;
            }
        }

    </script>

    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ONNX real-time detection -->
    <script src="/static/js/yolo-onnx-detector.js" defer></script>
</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-md p-4">
        <div class="max-w-screen-xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üì∑ Packing Staff Camera Dashboard (YOLOv10)</h1>
            <a href="/" class="text-blue-500 hover:underline">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>
    </nav>

    <main class="p-8 text-center">

        <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) -->
        <div class="mb-4">
            <label for="camera-dropdown" class="block mb-2 text-lg font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÇ‡∏ï‡πä‡∏∞):</label>
            <select id="camera-dropdown" class="border border-gray-300 rounded-md p-2">
                <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å populate ‡πÇ‡∏î‡∏¢ JavaScript -->
            </select>
        </div>


        <h2 class="text-2xl font-bold mb-6">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ YOLOv10 ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á</h2>

        <!-- Control panel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX -->
        <div class="mb-4 p-4 bg-white rounded-lg shadow-md">
            <h3 class="font-bold text-lg mb-2">üß† ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á AI</h3>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX -->
            <button id="load-model-btn" onclick="loadONNXModel()"
                class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 mb-3">
                üß† ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ONNX
            </button>

            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• -->
            <div id="model-status" class="model-status">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
            </div>

            <!-- Toggle switch ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö realtime -->
            <div class="toggle-wrapper mt-3">
                <label for="realtime-detection-switch">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ö‡∏ö Realtime:</label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="realtime-detection-switch" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>
        </div>

        <!-- Streaming Video -->
        <div class="flex justify-center mb-4">
            <div class="video-container">
                <div id="loading-spinner"></div>
                <img id="camera-stream" src="">
                <!-- ‚úÖ Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö real-time detection overlay -->
                <canvas id="detection-overlay"></canvas>
                <!-- Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î -->
                <div id="camera-off-overlay">
                    <div style="font-size: 48px;">üö´</div>
                    <div>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4 mb-4">
            <button id="start-camera" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                disabled>üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button id="stop-camera" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">üõë
                ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button id="capture"
                class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-600 flex items-center">
                <span id="button-text">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>
                <svg id="loading-spinner" class="hidden w-5 h-5 ml-2 animate-spin text-white"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8z"></path>
                </svg>
            </button>
        </div>

        <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° div ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° real-time detection -->
        <div id="camera-controls" class="mb-4">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
        </div>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö -->
        <section class="mt-8">
            <h3 class="text-2xl font-bold mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</h3>
            <div id="current-order" class="bg-white shadow-md p-4 rounded-md">
                <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</p>
            </div>
        </section>


        <!-- Detection Results -->
        <h3 class="text-lg font-bold mt-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</h3>
        <div id="detection-list" class="bg-white shadow-md text-gray-700"></div>

        <!-- Captured Image -->
        <h3 class="text-lg font-bold mt-4">üñºÔ∏è ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</h3>
        <div class="captured-container">
            <div class="captured-image-wrapper" id="captured-wrapper">
                <img id="captured-image" src="" alt="Captured Image" class="hidden">
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ packing -->
        <section class="mt-8">
            <h3 class="text-2xl font-bold mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</h3>
            <div id="packing-orders-list" class="bg-white shadow-md p-4 rounded-md">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </section>

    </main>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢ -->
    <div id="image-modal" class="modal">
        <span class="close" id="close-modal">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const stream = document.getElementById('camera-stream');
        const detectionList = document.getElementById('detection-list');
        const capturedImage = document.getElementById('captured-image');


        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const captureBtn = document.getElementById('capture');
        const buttonText = document.getElementById("button-text");
        const spinner = document.getElementById("loading-spinner");

        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const closeModal = document.getElementById('close-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const cameraOffOverlay = document.getElementById('camera-off-overlay');
        const cameraDropdown = document.getElementById('camera-dropdown');
        const packingOrdersList = document.getElementById('packing-orders-list');





        let currentCamera = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        loadingSpinner.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö

        // ‡∏ã‡πà‡∏≠‡∏ô spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å stream ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        stream.addEventListener('load', () => {
            loadingSpinner.style.display = 'none';
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô overlay ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
            cameraOffOverlay.style.display = 'none';
        });




        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å DB (‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ endpoint /packing/cameras ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON)
        async function loadCameraList() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('http://localhost:8001/packing/cameras', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/cameras', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching cameras: ${response.status}`);
                }
                const cameras = await response.json();
                // Populate dropdown
                cameraDropdown.innerHTML = '';
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ camera ‡∏°‡∏µ property table_number, name ‡πÅ‡∏•‡∏∞ stream_url
                    option.textContent = `‡∏Å‡∏•‡πâ‡∏≠‡∏á ${camera.name}`;
                    option.dataset.streamUrl = camera.stream_url;
                    cameraDropdown.appendChild(option);
                });
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (cameras.length > 0) {
                    currentCamera = cameras[0];
                    cameraDropdown.value = currentCamera.id;
                    stream.src = currentCamera.stream_url;
                    startCameraBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å dropdown ‡πÉ‡∏´‡πâ update ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á stream
        cameraDropdown.addEventListener('change', (e) => {
            const selectedOption = cameraDropdown.options[cameraDropdown.selectedIndex];
            currentCamera = {
                id: selectedOption.value,
                stream_url: selectedOption.dataset.streamUrl,
                table_number: selectedOption.textContent
            };
            stream.src = currentCamera.stream_url;
            startCameraBtn.disabled = false;
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ packing
        async function loadPackingOrders() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('http://localhost:8001/packing/orders/packing', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/orders/packing', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching packing orders: ${response.status}`);
                }
                const orders = await response.json();
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = '';
                if (orders.length === 0) {
                    packingOrdersList.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</p>';
                    return;
                }
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-center border-collapse border border-gray-200';
                table.innerHTML = `
                    <thead>
                      <tr class="bg-gray-200 text-gray-600 uppercase text-xs font-semibold">
                        <th class="py-2 px-3 border">Order ID</th>
                        <th class="py-2 px-3 border">Email</th>
                        <th class="py-2 px-3 border">Total</th>
                        <th class="py-2 px-3 border">Date</th>
                        <th class="py-2 px-3 border">Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á cell ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                    let actionCell = '';
                    if (order.assigned_to === null) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å assign ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô"
                        actionCell = `<button onclick="claimOrder(${order.id})" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤ already assigned (‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà assign ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                        actionCell = `<span class="text-green-600 font-semibold">In Progress</span>`;
                    }
                    tr.innerHTML = `
                        <td class="py-2 px-3 border">${order.id}</td>
                        <td class="py-2 px-3 border">${order.email}</td>
                        <td class="py-2 px-3 border">‡∏ø${order.total}</td>
                        <td class="py-2 px-3 border">${new Date(order.created_at).toLocaleDateString()}</td>
                        <td class="py-2 px-3 border">${actionCell}</td>
                    `;
                    tbody.appendChild(tr);
                });
                packingOrdersList.appendChild(table);
            } catch (error) {
                console.error(error);
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Claim Order)
        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        async function claimOrder(orderId) {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("‚ùå No Authorization Token Found");
                return;
            }

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/${orderId}/assign`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to assign order");
                }

                const orderData = await response.json();
                alert(`üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${orderData.order_id} ‡πÅ‡∏•‡πâ‡∏ß!`);

                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏ß‡πâ
                displayOrderDetails(orderData);

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                loadPackingOrders();

            } catch (error) {
                console.error("‚ùå Error claiming order:", error.message);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: " + error.message);
            }
        }



        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ
        function displayOrderDetails(orderData) {
            const currentOrderDiv = document.getElementById('current-order');

            if (!orderData) {
                currentOrderDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</p>';
                return;
            }

            let itemsHtml = "";
            orderData.items.forEach(item => {
                itemsHtml += `
                    <li class="border-b py-2">
                        <strong>${item.product_name}</strong> - ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô
                    </li>
                `;
            });

            currentOrderDiv.innerHTML = `
                <div class="p-4 border rounded-md bg-gray-100">
                    <p><strong>üÜî Order ID:</strong> ${orderData.order_id}</p>
                    <p><strong>üìß ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${orderData.customer_email}</p>
                    <p><strong>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</strong> ‡∏ø${orderData.total_price}</p>
                    <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${orderData.created_at}</p>
                    <h4 class="text-lg font-bold mt-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                    <ul class="mt-2">${itemsHtml}</ul>
                    <br>
                    <button class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                        onclick="verifyOrder(${orderData.order_id}, true)">‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö</button>
                    <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"
                        onclick="verifyOrder(${orderData.order_id}, false)">‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</button>
                </div>
            `;
        }




        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        startCameraBtn.addEventListener('click', async () => {
            try {
                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) {
                    throw new Error('‚ùå No Authorization Token Found');
                }

                cameraOffOverlay.style.display = 'none';
                loadingSpinner.style.display = 'block';

                if (!currentCamera) return;

                // ‚úÖ ‡πÉ‡∏ä‡πâ camera_id ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏£‡∏µ‡∏°
                stream.src = `http://localhost:8001/packing/stream?camera_id=${currentCamera.id}&token=${token}`;
                // stream.src = `https://thesis-api.jintaphas.tech/packing/stream?camera_id=${currentCamera.id}&token=${token}`;

                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                captureBtn.disabled = false;
            } catch (error) {
                console.error('‚ùå Error starting camera:', error.message);
            }
        });

        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        stopCameraBtn.addEventListener('click', async () => {
            try {
                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) {
                    throw new Error('‚ùå No Authorization Token Found');
                }

                // ‚úÖ ‡πÉ‡∏ä‡πâ camera_id ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                await fetch(`http://localhost:8001/packing/stop-stream?camera_id=${currentCamera.id}`, {
                    // await fetch(`https://thesis-api.jintaphas.tech/packing/stop-stream?camera_id=${currentCamera.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                stream.src = ''; // ‡∏õ‡∏¥‡∏î stream
                cameraOffOverlay.style.display = 'flex';
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                captureBtn.disabled = true;

                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô real-time detection ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
                if (window.yoloDetector && window.yoloDetector.isRunning) {
                    window.yoloDetector.stop();
                }
            } catch (error) {
                console.error('‚ùå Error stopping camera:', error.message);
            }
        });


        captureBtn.addEventListener('click', async () => {
            try {

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
                captureBtn.disabled = true;
                buttonText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û...";
                spinner.classList.remove("hidden");

                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) throw new Error('‚ùå No Authorization Token Found');
                if (!currentCamera) throw new Error('‚ùå No Camera Selected');

                // ‚úÖ ‡πÉ‡∏ä‡πâ camera_id ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà backend
                const response = await fetch(`http://localhost:8001/packing/snapshot?camera_id=${currentCamera.id}`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/snapshot?camera_id=${currentCamera.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`‚ùå Server responded with ${response.status}: ${response.statusText}`);
                }

                // ‡πÄ‡∏Å‡πá‡∏ö blob ‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ
                const imageBlob = await response.blob();
                const formData = new FormData();
                formData.append('file', imageBlob, 'captured_image.png');

                // console.log('üì∏ Sending captured image to backend...');

                const detectResponse = await fetch('http://localhost:8001/packing/detect', {
                    // const detectResponse = await fetch('https://thesis-api.jintaphas.tech/packing/detect', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!detectResponse.ok) {
                    throw new Error(`‚ùå Server responded with ${detectResponse.status}: ${detectResponse.statusText}`);
                }

                const result = await detectResponse.json();
                // console.log('‚úÖ Detection result:', result);

                captureBtn.disabled = false;
                buttonText.textContent = "üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û";
                spinner.classList.add("hidden");

                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
                detectionList.innerHTML = '';
                if (result.detections.length > 0) {
                    result.detections.forEach(det => {
                        const listItem = document.createElement('div');
                        listItem.innerHTML = `<strong>${det.label}</strong> - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(det.confidence * 100).toFixed(1)}%`;
                        detectionList.appendChild(listItem);
                    });
                } else {
                    detectionList.innerHTML = `<div class="text-red-500 font-semibold">‚ùå AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>`;
                }



                const imgURL = URL.createObjectURL(imageBlob);
                capturedImage.src = imgURL;
                capturedImage.classList.remove('hidden');
                capturedImage.onclick = () => {
                    modal.style.display = 'block';
                    modalImg.src = capturedImage.src;
                };


            } catch (error) {
                console.error('‚ùå Error capturing and detecting image:', error.message);
                detectionList.innerHTML = `<div class="text-red-500 font-semibold">${error.message}</div>`;

                captureBtn.disabled = false;
                buttonText.textContent = "üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û";
                spinner.classList.add("hidden");
            }
        });


        async function verifyOrder(orderId, isVerified) {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("‚ùå No Authorization Token Found");
                return;
            }

            const formData = new FormData();
            formData.append("verified", isVerified);

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const capturedImage = document.getElementById('captured-image');
            if (capturedImage.src && capturedImage.src.startsWith("blob")) {
                const response = await fetch(capturedImage.src);
                const blob = await response.blob();
                formData.append("file", blob, "captured_image.jpg");
            } else {
                alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
                return;
            }

            // ‚úÖ DEBUG: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ
            // console.log("üîç FormData ‡∏™‡πà‡∏á‡πÑ‡∏õ:", formData);

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/${orderId}/verify`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/verify`, {
                    method: "PUT",
                    headers: { "Authorization": `Bearer ${token}` },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail);
                }

                alert(result.message);

                // FIXME: ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏Ñ‡πà 
                // üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing ‡πÅ‡∏•‡∏∞ üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏
                window.location.reload();
            } catch (error) {
                alert("‚ùå " + error.message);
            }
        }


        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
        closeModal.onclick = () => {
            modal.style.display = 'none';
        };

    </script>
</body>

</html>