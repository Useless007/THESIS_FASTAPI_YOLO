<!-- # app/templates/packing_dashboard.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Staff Camera Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <style>
        /* Container wrapper สำหรับ video stream, spinner และ overlay */
        .video-container {
            position: relative;
            display: inline-block;
            border: 3px solid #3498db;
            /* เพิ่มกรอบสีฟ้า */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 15px;
        }

        /* สไตล์สำหรับภาพ stream */
        #stream {
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 640px;
            height: 480px;
            display: block;
        }

        /* สไตล์ spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin: -25px 0 0 -25px;
            /* เลื่อนให้อยู่ตรงกลาง */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Overlay เมื่อกล้องถูกปิด */
        #camera-off-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 8px;
            z-index: 15;
            display: none;
        }

        /* ส่วนอื่นๆ */
        #canvas {
            display: none;
        }

        #detection-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
        }

        .captured-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .captured-image-wrapper {
            position: relative;
            cursor: pointer;
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .captured-image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            margin: 5% auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
        }

        .modal img {
            width: 100%;
            height: auto;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ✅ สไตล์สำหรับ camera-controls */
        #camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* สไตล์สำหรับ toggle switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .toggle-wrapper label {
            margin-right: 10px;
            font-weight: bold;
        }

        /* พื้นที่แสดงสถานะการตรวจจับ */
        .detect-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .detect-status.loading {
            background-color: #fff3cd;
            color: #856404;
            display: block;
        }

        .detect-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .detect-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }

        /* ✅ เพิ่ม style สำหรับ dual-stream container */
        .overlay-text {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        #dual-detection-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .detection-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .detection-item:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>

    <script>
        // ✅ โหลดออเดอร์ที่รับมาแล้วตอนเปิดหน้าเว็บ
        async function loadCurrentOrder() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) return;

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/current`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/current`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch order");

                const orderData = await response.json();

                // ✅ ถ้ามีออเดอร์ ให้แสดงผล & บันทึกลง localStorage
                if (orderData.order_id) {
                    localStorage.setItem("currentOrderId", orderData.order_id);
                    displayOrderDetails(orderData);
                } else {
                    localStorage.removeItem("currentOrderId");  // ✅ ถ้าไม่มีออเดอร์ให้ลบ localStorage
                    displayOrderDetails(null);
                }

            } catch (error) {
                console.error("❌ Error loading current order:", error.message);
                displayOrderDetails(null);
            }
        }


        // ✅ โหลดข้อมูลเมื่อหน้าเว็บเปิด
        document.addEventListener('DOMContentLoaded', () => {
            loadCameraList();
            loadPackingOrders();
            loadCurrentOrder();  // โหลดออเดอร์ที่รับอยู่

            // แสดงกรอบของ video container ตั้งแต่โหลดหน้า
            const videoContainer = document.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'inline-block';
            }

            // ตั้งค่า toggle switches
            setupToggleSwitches();
        });

        // ✅ เพิ่ม JavaScript สำหรับการแสดงภาพแบบคู่ (dual stream)
        function setupDualStreamConnection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ ไม่พบ Token สำหรับการยืนยันตัวตน");
                document.getElementById('dual-stream-switch').checked = false;
                return;
            }

            if (!currentCamera) {
                alert("❌ กรุณาเลือกกล้องก่อน");
                document.getElementById('dual-stream-switch').checked = false;
                return;
            }

            // สร้าง WebSocket connection
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            const port = "8001";  // ใช้พอร์ต 8001

            // ปิด WebSocket เดิมถ้ามีอยู่
            if (window.dualStreamWS) {
                window.dualStreamWS.close();
            }

            // สร้าง WebSocket ใหม่
            window.dualStreamWS = new WebSocket(`${wsProtocol}//${host}:${port}/packing/ws/dual-stream?camera_id=${currentCamera.id}`);

            // เมื่อเชื่อมต่อสำเร็จ
            window.dualStreamWS.onopen = () => {
                console.log('✅ WebSocket connected for dual stream');
                document.getElementById('detect-status').textContent = 'กำลังแสดงภาพแบบคู่';
                document.getElementById('detect-status').className = 'detect-status success';
            };

            // เมื่อได้รับข้อมูลจาก server
            window.dualStreamWS.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.error) {
                    console.error('❌ Error from server:', data.error);
                    return;
                }

                // แสดงข้อมูลการตรวจจับ
                const dualDetectionList = document.getElementById('dual-detection-list');
                dualDetectionList.innerHTML = '';

                if (!data.detections || data.detections.length === 0) {
                    dualDetectionList.innerHTML = '<div class="text-gray-500">ไม่พบวัตถุใดในภาพ</div>';
                } else {
                    // นับจำนวนวัตถุแต่ละประเภท
                    const counts = {};
                    data.detections.forEach(detection => {
                        const label = detection.label;
                        counts[label] = (counts[label] || 0) + 1;
                    });

                    // แสดงผลลัพธ์
                    for (const [label, count] of Object.entries(counts)) {
                        const item = document.createElement('div');
                        item.className = 'detection-item';
                        item.innerHTML = `<span class="font-bold">${label}</span> <span class="text-blue-600">${count} ชิ้น</span>`;
                        dualDetectionList.appendChild(item);
                    }
                }

                // แสดงภาพต้นฉบับ
                if (data.raw_image) {
                    document.getElementById('raw-stream').src = 'data:image/jpeg;base64,' + data.raw_image;
                }

                // แสดงภาพที่มีการวาดกรอบการตรวจจับ
                if (data.annotated_image) {
                    document.getElementById('annotated-stream').src = 'data:image/jpeg;base64,' + data.annotated_image;
                }
            };

            // เมื่อการเชื่อมต่อถูกปิด
            window.dualStreamWS.onclose = () => {
                console.log('⚠️ WebSocket disconnected for dual stream');
                document.getElementById('detect-status').textContent = 'การเชื่อมต่อแบบคู่ถูกปิด';
                document.getElementById('detect-status').className = 'detect-status';
            };

            // เมื่อเกิดข้อผิดพลาด
            window.dualStreamWS.onerror = (error) => {
                console.error('❌ WebSocket error:', error);
                document.getElementById('detect-status').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error;
                document.getElementById('detect-status').className = 'detect-status error';
                document.getElementById('dual-stream-switch').checked = false;
            };
        }

        // ฟังก์ชั่นตั้งค่า toggle switches
        function setupToggleSwitches() {
            // ติดตั้ง event listener สำหรับ switch การตรวจจับแบบ realtime
            const detectSwitch = document.getElementById('realtime-detection-switch');
            if (detectSwitch) {
                detectSwitch.addEventListener('change', function () {
                    if (this.checked) {
                        // เปิดการตรวจจับ realtime แบบ server-side
                        startServerSideDetection();
                    } else {
                        // ปิดการตรวจจับ realtime แบบ server-side
                        stopServerSideDetection();
                    }
                });
            }

            // ติดตั้ง event listener สำหรับ switch การตรวจจับบนกล้องโดยตรงแบบ realtime
            const directDetectSwitch = document.getElementById('direct-realtime-detection-switch');
            if (directDetectSwitch) {
                directDetectSwitch.addEventListener('change', function () {
                    if (this.checked) {
                        // เปิดการตรวจจับ realtime แบบ client-side
                        startDirectRealtimeDetection();
                    } else {
                        // ปิดการตรวจจับ realtime แบบ client-side
                        stopDirectRealtimeDetection();
                    }
                });
            }

            // ติดตั้ง event listener สำหรับ switch การแสดงภาพแบบคู่
            const dualStreamSwitch = document.getElementById('dual-stream-switch');
            if (dualStreamSwitch) {
                dualStreamSwitch.addEventListener('change', function () {
                    const dualStreamContainer = document.getElementById('dual-stream-container');
                    const dualDetectionResults = document.getElementById('dual-detection-results');

                    if (this.checked) {
                        // เริ่มการเชื่อมต่อแบบคู่
                        setupDualStreamConnection();
                        dualStreamContainer.style.display = 'flex';
                        dualDetectionResults.style.display = 'block';
                    } else {
                        // ปิดการเชื่อมต่อแบบคู่
                        if (window.dualStreamWS) {
                            window.dualStreamWS.close();
                            window.dualStreamWS = null;
                        }
                        dualStreamContainer.style.display = 'none';
                        dualDetectionResults.style.display = 'none';
                    }
                });
            }
        }

        // เริ่มการตรวจจับแบบ server-side realtime
        function startServerSideDetection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ ไม่พบ Token สำหรับการยืนยันตัวตน");
                document.getElementById('realtime-detection-switch').checked = false;
                return;
            }

            if (!currentCamera) {
                alert("❌ กรุณาเลือกกล้องก่อน");
                document.getElementById('realtime-detection-switch').checked = false;
                return;
            }

            // แสดงสถานะกำลังตรวจจับ
            document.getElementById('detect-status').textContent = 'กำลังเริ่มการตรวจจับแบบ realtime...';
            document.getElementById('detect-status').className = 'detect-status loading';

            try {
                // เปลี่ยน src ของ stream เป็น endpoint สำหรับ realtime detection
                const cameraStream = document.getElementById('camera-stream');
                cameraStream.src = `http://localhost:8001/packing/realtime-detect?camera_id=${currentCamera.id}&token=${token}`;
                // cameraStream.src = `https://thesis-api.jintaphas.tech/packing/realtime-detect?camera_id=${currentCamera.id}&token=${token}`;

                document.getElementById('detect-status').textContent = 'กำลังตรวจจับแบบ realtime';
                document.getElementById('detect-status').className = 'detect-status success';
            } catch (error) {
                console.error("❌ Error starting realtime detection:", error);
                document.getElementById('detect-status').textContent = 'เกิดข้อผิดพลาดในการเริ่มตรวจจับ: ' + error.message;
                document.getElementById('detect-status').className = 'detect-status error';
                document.getElementById('realtime-detection-switch').checked = false;
            }
        }

        // หยุดการตรวจจับแบบ server-side realtime
        async function stopServerSideDetection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ ไม่พบ Token สำหรับการยืนยันตัวตน");
                return;
            }

            if (!currentCamera) {
                return;
            }

            try {
                // หยุดการตรวจจับแบบ realtime บน server
                await fetch(`http://localhost:8001/packing/stop-realtime?camera_id=${currentCamera.id}`, {
                    // await fetch(`https://thesis-api.jintaphas.tech/packing/stop-realtime?camera_id=${currentCamera.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // เปลี่ยนกลับไปใช้ stream ปกติ
                const cameraStream = document.getElementById('camera-stream');
                cameraStream.src = `http://localhost:8001/packing/stream?camera_id=${currentCamera.id}&token=${token}`;
                // cameraStream.src = `https://thesis-api.jintaphas.tech/packing/stream?camera_id=${currentCamera.id}&token=${token}`;

                document.getElementById('detect-status').textContent = 'หยุดการตรวจจับแบบ realtime แล้ว';
                document.getElementById('detect-status').className = 'detect-status';
            } catch (error) {
                console.error("❌ Error stopping realtime detection:", error);
                document.getElementById('detect-status').textContent = 'เกิดข้อผิดพลาดในการหยุดตรวจจับ: ' + error.message;
                document.getElementById('detect-status').className = 'detect-status error';
            }
        }

        // เริ่มการตรวจจับแบบ direct realtime detection จากกล้องที่เลือก
        async function startDirectRealtimeDetection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ ไม่พบ Token สำหรับการยืนยันตัวตน");
                document.getElementById('direct-realtime-detection-switch').checked = false;
                return;
            }

            if (!currentCamera) {
                alert("❌ กรุณาเลือกกล้องก่อน");
                document.getElementById('direct-realtime-detection-switch').checked = false;
                return;
            }

            // แสดงสถานะกำลังตรวจจับ
            document.getElementById('detect-status').textContent = 'กำลังเริ่มการตรวจจับแบบ realtime จากกล้องโดยตรง...';
            document.getElementById('detect-status').className = 'detect-status loading';

            try {
                // สร้าง WebSocket connection โดยใช้พอร์ต 8001
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const port = "8001";  // ใช้พอร์ต 8001 แทนที่จะใช้ window.location.port

                if (window.realtimeDetectionWS) {
                    window.realtimeDetectionWS.close();
                }

                // สร้าง WebSocket ใหม่เพื่อติดต่อกับ server ที่ port 8001
                window.realtimeDetectionWS = new WebSocket(`${wsProtocol}//${host}:${port}/packing/ws/camera-detect?camera_id=${currentCamera.id}`);

                window.realtimeDetectionWS.onopen = () => {
                    console.log('✅ WebSocket connected for camera detection');
                    document.getElementById('detect-status').textContent = 'กำลังตรวจจับแบบ realtime จากกล้องโดยตรง';
                    document.getElementById('detect-status').className = 'detect-status success';

                    // ปิดปุ่มอื่นๆ ระหว่างที่ตรวจจับ
                    document.getElementById('realtime-detection-switch').disabled = true;
                    document.getElementById('capture').disabled = true;
                };

                window.realtimeDetectionWS.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        console.error('❌ Error from server:', data.error);
                        return;
                    }

                    // แสดงข้อมูลการตรวจจับ
                    displayDetections(data.detections);

                    // แสดงภาพที่มีการวาดกรอบแล้ว
                    const cameraStream = document.getElementById('camera-stream');
                    if (data.image) {
                        cameraStream.src = 'data:image/jpeg;base64,' + data.image;
                    }
                };

                window.realtimeDetectionWS.onclose = () => {
                    console.log('⚠️ WebSocket disconnected for camera detection');
                    stopDirectRealtimeDetection();
                };

                window.realtimeDetectionWS.onerror = (error) => {
                    console.error('❌ WebSocket error:', error);
                    document.getElementById('detect-status').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error;
                    document.getElementById('detect-status').className = 'detect-status error';
                    stopDirectRealtimeDetection();
                };
            } catch (error) {
                console.error("❌ Error starting direct realtime detection:", error);
                document.getElementById('detect-status').textContent = 'เกิดข้อผิดพลาดในการเริ่มตรวจจับ: ' + error.message;
                document.getElementById('detect-status').className = 'detect-status error';
                document.getElementById('direct-realtime-detection-switch').checked = false;
            }
        }

        // หยุดการตรวจจับแบบ direct realtime
        function stopDirectRealtimeDetection() {
            try {
                if (window.realtimeDetectionWS) {
                    window.realtimeDetectionWS.close();
                    window.realtimeDetectionWS = null;
                }

                document.getElementById('detect-status').textContent = 'หยุดการตรวจจับแบบ realtime แล้ว';
                document.getElementById('detect-status').className = 'detect-status';

                // เปิดปุ่มต่างๆ กลับมา
                document.getElementById('realtime-detection-switch').disabled = false;
                document.getElementById('capture').disabled = false;

                // ถ้าเปิดกล้องอยู่ ให้กลับไปใช้ stream ปกติ
                if (!document.getElementById('start-camera').disabled) {
                    const token = document.cookie.split('; ')
                        .find(row => row.startsWith('Authorization='))?.split('=')[1];
                    if (token && currentCamera) {
                        const cameraStream = document.getElementById('camera-stream');
                        cameraStream.src = `http://localhost:8001/packing/stream?camera_id=${currentCamera.id}&token=${token}`;
                    }
                }
            } catch (error) {
                console.error("❌ Error stopping direct realtime detection:", error);
            }
        }

        // แสดงผลการตรวจจับในหน้าเว็บ
        function displayDetections(detections) {
            const detectionList = document.getElementById('detection-list');
            detectionList.innerHTML = '';

            if (!detections || detections.length === 0) {
                detectionList.innerHTML = '<div class="text-gray-500">ไม่พบวัตถุใดในภาพ</div>';
                return;
            }

            // นับจำนวนวัตถุแต่ละประเภท
            const counts = {};
            detections.forEach(detection => {
                const label = detection.label;
                counts[label] = (counts[label] || 0) + 1;
            });

            // แสดงผลลัพธ์
            for (const [label, count] of Object.entries(counts)) {
                const item = document.createElement('div');
                item.className = 'py-2 border-b';
                item.innerHTML = `<span class="font-bold">${label}</span>: <span class="text-blue-600">${count} ชิ้น</span>`;
                detectionList.appendChild(item);
            }
        }

        // ฟังก์ชันเปิดการตรวจจับแบบสตรีมโดยตรง
        function openDirectRealtimeDetection() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ ไม่พบ Token สำหรับการยืนยันตัวตน");
                return;
            }

            if (!currentCamera) {
                alert("❌ กรุณาเลือกกล้องก่อน");
                return;
            }

            // เปิดหน้าต่างใหม่สำหรับการตรวจจับแบบสตรีมโดยตรง
            const directUrl = `http://localhost:8001/packing/realtime-detect-direct?camera_id=${currentCamera.id}&token=${token}`;
            window.open(directUrl, '_blank', 'width=680,height=520');
        }
    </script>
</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-md p-4">
        <div class="max-w-screen-xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">📷 Packing Staff Camera Dashboard (YOLOv10)</h1>
            <a href="/" class="text-blue-500 hover:underline">กลับสู่หน้าแรก</a>
        </div>
    </nav>

    <main class="p-8 text-center">

        <!-- Dropdown สำหรับเลือกกล้อง (แสดงโต๊ะที่ใช้งาน) -->
        <div class="mb-4">
            <label for="camera-dropdown" class="block mb-2 text-lg font-semibold">เลือกกล้อง (โต๊ะ):</label>
            <select id="camera-dropdown" class="border border-gray-300 rounded-md p-2">
                <!-- ตัวเลือกจะถูก populate โดย JavaScript -->
            </select>
        </div>


        <h2 class="text-2xl font-bold mb-6">🔍 ตรวจจับสินค้าในภาพด้วย YOLOv10 ผ่านกล้อง</h2>

        <!-- Control panel สำหรับการตรวจจับ -->
        <div class="mb-4 p-4 bg-white rounded-lg shadow-md">
            <h3 class="font-bold text-lg mb-2">🧠 ควบคุมการทำงานของ AI</h3>

            <!-- สถานะการตรวจจับ -->
            <div id="detect-status" class="detect-status">
                ยังไม่ได้เริ่มการตรวจจับ
            </div>

            <!-- Toggle switch สำหรับเปิด/ปิดการตรวจจับแบบ realtime -->
            <div class="toggle-wrapper mt-3">
                <label for="realtime-detection-switch">การตรวจจับแบบ Realtime:</label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="realtime-detection-switch" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>

            <!-- ใหม่: Toggle switch สำหรับเปิด/ปิดการตรวจจับวัตถุบนกล้องที่เลือกโดยตรง -->
            <div class="toggle-wrapper mt-3">
                <label for="direct-realtime-detection-switch">การตรวจจับบนกล้องโดยตรง (Realtime):</label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="direct-realtime-detection-switch" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>

            <!-- ✅ เพิ่ม UI สำหรับแสดงภาพต้นฉบับและภาพที่มีการตรวจจับวัตถุพร้อมกัน -->
            <div class="toggle-wrapper mt-3">
                <label for="dual-stream-switch">แสดงภาพแบบคู่:</label>
                <input type="checkbox" id="dual-stream-switch" class="toggle-switch">
            </div>
        </div>

        <!-- Streaming Video -->
        <div class="flex justify-center mb-4">
            <div class="video-container">
                <div id="loading-spinner"></div>
                <img id="camera-stream" src="">
                <!-- Overlay เมื่อกล้องถูกปิด -->
                <div id="camera-off-overlay">
                    <div style="font-size: 48px;">🚫</div>
                    <div>กล้องถูกปิดอยู่</div>
                </div>
            </div>
        </div>

        <!-- ✅ Container สำหรับแสดงภาพแบบคู่ -->
        <div id="dual-stream-container"
            style="display: none; flex-direction: row; justify-content: center; gap: 20px; margin-top: 15px;">
            <div class="video-container" style="max-width: 400px;">
                <img id="raw-stream" src="" alt="Raw Stream" style="width: 100%; height: auto; border: 2px solid #ccc;">
                <div class="overlay-text">ภาพต้นฉบับ</div>
            </div>
            <div class="video-container" style="max-width: 400px;">
                <img id="annotated-stream" src="" alt="Annotated Stream"
                    style="width: 100%; height: auto; border: 2px solid #3498db;">
                <div class="overlay-text">ภาพจับวัตถุ</div>
            </div>
        </div>

        <!-- ✅ ส่วนแสดงผลการตรวจจับ -->
        <div id="dual-detection-results"
            style="display: none; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>ผลการตรวจจับวัตถุ</h3>
            <div id="dual-detection-list"></div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4 mb-4">
            <button id="start-camera" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                disabled>📸 เปิดกล้อง</button>
            <button id="stop-camera" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">🛑
                ปิดกล้อง</button>
            <button id="capture"
                class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-600 flex items-center">
                <span id="button-text">📸 ถ่ายภาพ</span>
                <svg id="loading-spinner" class="hidden w-5 h-5 ml-2 animate-spin text-white"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8z"></path>
                </svg>
            </button>
            <a href="http://localhost:8001/packing/realtime-webcam" target="_blank"
                class="bg-purple-500 text-white px-6 py-3 rounded-lg shadow hover:bg-purple-600 flex items-center">
                🎥 เปิดการตรวจจับแบบ Webcam Realtime
            </a>
            <a href="javascript:void(0)" onclick="openDirectRealtimeDetection()"
                class="bg-green-500 text-white px-6 py-3 rounded-lg shadow hover:bg-green-600 flex items-center ml-2">
                🎯 เปิดการตรวจจับแบบสตรีมโดยตรง
            </a>
        </div>

        <!-- ✅ เพิ่ม div สำหรับปุ่มควบคุม real-time detection -->
        <div id="camera-controls" class="mb-4">
            <!-- ปุ่มจะถูกเพิ่มโดย JavaScript -->
        </div>

        <!-- แสดงข้อมูลออเดอร์ที่รับ -->
        <section class="mt-8">
            <h3 class="text-2xl font-bold mb-4">📦 รายละเอียดออเดอร์ที่กำลังบรรจุ</h3>
            <div id="current-order" class="bg-white shadow-md p-4 rounded-md">
                <p class="text-gray-500">ยังไม่มีออเดอร์ที่รับ</p>
            </div>
        </section>


        <!-- Detection Results -->
        <h3 class="text-lg font-bold mt-4">📋 รายการสิ่งที่ตรวจพบ:</h3>
        <div id="detection-list" class="bg-white shadow-md text-gray-700"></div>

        <!-- Captured Image -->
        <h3 class="text-lg font-bold mt-4">🖼️ ภาพที่ถ่ายได้:</h3>
        <div class="captured-container">
            <div class="captured-image-wrapper" id="captured-wrapper">
                <img id="captured-image" src="" alt="Captured Image" class="hidden">
            </div>
        </div>

        <!-- ส่วนแสดงรายการคำสั่งซื้อที่มีสถานะ packing -->
        <section class="mt-8">
            <h3 class="text-2xl font-bold mb-4">📦 รายการคำสั่งซื้อที่กำลัง Packing</h3>
            <div id="packing-orders-list" class="bg-white shadow-md p-4 rounded-md">
                <!-- รายการคำสั่งซื้อจะถูกดึงและแสดงที่นี่ -->
            </div>
        </section>

    </main>

    <!-- Modal สำหรับแสดงภาพขยาย -->
    <div id="image-modal" class="modal">
        <span class="close" id="close-modal">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const stream = document.getElementById('camera-stream');
        const detectionList = document.getElementById('detection-list');
        const capturedImage = document.getElementById('captured-image');


        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const captureBtn = document.getElementById('capture');
        const buttonText = document.getElementById("button-text");
        const spinner = document.getElementById("loading-spinner");

        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const closeModal = document.getElementById('close-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const cameraOffOverlay = document.getElementById('camera-off-overlay');
        const cameraDropdown = document.getElementById('camera-dropdown');
        const packingOrdersList = document.getElementById('packing-orders-list');





        let currentCamera = null; // เก็บข้อมูลกล้องที่เลือก
        loadingSpinner.style.display = 'none'; // ซ่อน spinner เมื่อเริ่มโหลดหน้าเว็บ

        // ซ่อน spinner เมื่อภาพจาก stream โหลดเสร็จ
        stream.addEventListener('load', () => {
            loadingSpinner.style.display = 'none';
            // เมื่อภาพโหลดแล้วให้ซ่อน overlay ถ้ามีการแสดงอยู่ (กรณีเปิดกล้องใหม่)
            cameraOffOverlay.style.display = 'none';
        });




        // โหลดรายชื่อกล้องจาก DB (สมมุติว่า endpoint /packing/cameras คืนข้อมูล JSON)
        async function loadCameraList() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('http://localhost:8001/packing/cameras', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/cameras', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching cameras: ${response.status}`);
                }
                const cameras = await response.json();
                // Populate dropdown
                cameraDropdown.innerHTML = '';
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    // สมมุติว่า camera มี property table_number, name และ stream_url
                    option.textContent = `กล้อง ${camera.name}`;
                    option.dataset.streamUrl = camera.stream_url;
                    cameraDropdown.appendChild(option);
                });
                // เลือกกล้องตัวแรกเป็นค่าเริ่มต้น
                if (cameras.length > 0) {
                    currentCamera = cameras[0];
                    cameraDropdown.value = currentCamera.id;
                    stream.src = currentCamera.stream_url;
                    startCameraBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
            }
        }

        // เมื่อเลือกกล้องจาก dropdown ให้ update การแสดงผลของ stream
        cameraDropdown.addEventListener('change', (e) => {
            const selectedOption = cameraDropdown.options[cameraDropdown.selectedIndex];
            currentCamera = {
                id: selectedOption.value,
                stream_url: selectedOption.dataset.streamUrl,
                table_number: selectedOption.textContent
            };
            stream.src = currentCamera.stream_url;
            startCameraBtn.disabled = false;
        });

        // โหลดรายการคำสั่งซื้อที่มีสถานะ packing
        async function loadPackingOrders() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('http://localhost:8001/packing/orders/packing', {
                    // const response = await fetch('https://thesis-api.jintaphas.tech/packing/orders/packing', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching packing orders: ${response.status}`);
                }
                const orders = await response.json();
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = '';
                if (orders.length === 0) {
                    packingOrdersList.innerHTML = '<p class="text-gray-500">ไม่มีคำสั่งซื้อที่กำลัง Packing</p>';
                    return;
                }
                // สร้างตารางสำหรับแสดงรายการคำสั่งซื้อ
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-center border-collapse border border-gray-200';
                table.innerHTML = `
                    <thead>
                      <tr class="bg-gray-200 text-gray-600 uppercase text-xs font-semibold">
                        <th class="py-2 px-3 border">Order ID</th>
                        <th class="py-2 px-3 border">Email</th>
                        <th class="py-2 px-3 border">Total</th>
                        <th class="py-2 px-3 border">Date</th>
                        <th class="py-2 px-3 border">Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    // สร้าง cell สำหรับปุ่มรับงาน
                    let actionCell = '';
                    if (order.assigned_to === null) {
                        // ถ้ายังไม่ถูก assign ให้แสดงปุ่ม "รับงาน"
                        actionCell = `<button onclick="claimOrder(${order.id})" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">รับงาน</button>`;
                    } else {
                        // ถ้า already assigned (จะเป็นออเดอร์ที่ assign ให้กับพนักงานปัจจุบัน)
                        actionCell = `<span class="text-green-600 font-semibold">In Progress</span>`;
                    }
                    tr.innerHTML = `
                        <td class="py-2 px-3 border">${order.id}</td>
                        <td class="py-2 px-3 border">${order.email}</td>
                        <td class="py-2 px-3 border">฿${order.total}</td>
                        <td class="py-2 px-3 border">${new Date(order.created_at).toLocaleDateString()}</td>
                        <td class="py-2 px-3 border">${actionCell}</td>
                    `;
                    tbody.appendChild(tr);
                });
                packingOrdersList.appendChild(table);
            } catch (error) {
                console.error(error);
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาด: ${error.message}</p>`;
            }
        }

        // ฟังก์ชันสำหรับให้พนักงานรับงาน (Claim Order)
        // ✅ ฟังก์ชันสำหรับให้พนักงานรับออเดอร์
        async function claimOrder(orderId) {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ No Authorization Token Found");
                return;
            }

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/${orderId}/assign`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to assign order");
                }

                const orderData = await response.json();
                alert(`🎉 คุณได้รับออเดอร์ ${orderData.order_id} แล้ว!`);

                // ✅ แสดงข้อมูลออเดอร์ที่รับไว้
                displayOrderDetails(orderData);

                // ✅ โหลดออเดอร์ที่ยังไม่ได้รับใหม่
                loadPackingOrders();

            } catch (error) {
                console.error("❌ Error claiming order:", error.message);
                alert("เกิดข้อผิดพลาดในการรับงาน: " + error.message);
            }
        }



        // ✅ ฟังก์ชันแสดงข้อมูลออเดอร์ที่กำลังแพ็ค
        function displayOrderDetails(orderData) {
            const currentOrderDiv = document.getElementById('current-order');

            if (!orderData) {
                currentOrderDiv.innerHTML = '<p class="text-gray-500">ยังไม่มีออเดอร์ที่รับ</p>';
                return;
            }

            let itemsHtml = "";
            orderData.items.forEach(item => {
                itemsHtml += `
                    <li class="border-b py-2">
                        <strong>${item.product_name}</strong> - ${item.quantity} ชิ้น
                    </li>
                `;
            });

            currentOrderDiv.innerHTML = `
                <div class="p-4 border rounded-md bg-gray-100">
                    <p><strong>🆔 Order ID:</strong> ${orderData.order_id}</p>
                    <p><strong>📧 ลูกค้า:</strong> ${orderData.customer_email}</p>
                    <p><strong>💰 ราคารวม:</strong> ฿${orderData.total_price}</p>
                    <p><strong>📅 วันที่:</strong> ${orderData.created_at}</p>
                    <h4 class="text-lg font-bold mt-4">📦 รายการสินค้า</h4>
                    <ul class="mt-2">${itemsHtml}</ul>
                    <br>
                    <button class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                        onclick="verifyOrder(${orderData.order_id}, true)">✅ สินค้าครบ</button>
                    <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"
                        onclick="verifyOrder(${orderData.order_id}, false)">❌ สินค้ายังไม่ครบ</button>
                </div>
            `;
        }




        // เปิดกล้อง
        startCameraBtn.addEventListener('click', async () => {
            try {
                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) {
                    throw new Error('❌ No Authorization Token Found');
                }

                cameraOffOverlay.style.display = 'none';
                loadingSpinner.style.display = 'block';

                if (!currentCamera) return;

                // ✅ ใช้ camera_id ในการสตรีม
                stream.src = `http://localhost:8001/packing/stream?camera_id=${currentCamera.id}&token=${token}`;
                // stream.src = `https://thesis-api.jintaphas.tech/packing/stream?camera_id=${currentCamera.id}&token=${token}`;

                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                captureBtn.disabled = false;
            } catch (error) {
                console.error('❌ Error starting camera:', error.message);
            }
        });

        // ปิดกล้อง
        stopCameraBtn.addEventListener('click', async () => {
            try {
                // ถ้า realtime detection switch เปิดอยู่ ให้ปิดก่อน
                const detectSwitch = document.getElementById('realtime-detection-switch');
                if (detectSwitch && detectSwitch.checked) {
                    detectSwitch.checked = false;
                    await stopServerSideDetection();
                }

                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) {
                    throw new Error('❌ No Authorization Token Found');
                }

                // ✅ ใช้ camera_id ในการปิดกล้อง
                await fetch(`http://localhost:8001/packing/stop-stream?camera_id=${currentCamera.id}`, {
                    // await fetch(`https://thesis-api.jintaphas.tech/packing/stop-stream?camera_id=${currentCamera.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                stream.src = ''; // ปิด stream
                cameraOffOverlay.style.display = 'flex';
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                captureBtn.disabled = true;

                document.getElementById('detect-status').textContent = 'ยังไม่ได้เริ่มการตรวจจับ';
                document.getElementById('detect-status').className = 'detect-status';
            } catch (error) {
                console.error('❌ Error stopping camera:', error.message);
            }
        });


        captureBtn.addEventListener('click', async () => {
            try {

                // แสดงสถานะกำลังโหลด
                captureBtn.disabled = true;
                buttonText.textContent = "กำลังถ่ายภาพ...";
                spinner.classList.remove("hidden");

                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];

                if (!token) throw new Error('❌ No Authorization Token Found');
                if (!currentCamera) throw new Error('❌ No Camera Selected');

                // ✅ ใช้ camera_id ส่งไปที่ backend
                const response = await fetch(`http://localhost:8001/packing/snapshot?camera_id=${currentCamera.id}`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/snapshot?camera_id=${currentCamera.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`❌ Server responded with ${response.status}: ${response.statusText}`);
                }

                // เก็บ blob รูปต้นฉบับไว้
                const imageBlob = await response.blob();
                const formData = new FormData();
                formData.append('file', imageBlob, 'captured_image.png');

                // console.log('📸 Sending captured image to backend...');

                const detectResponse = await fetch('http://localhost:8001/packing/detect', {
                    // const detectResponse = await fetch('https://thesis-api.jintaphas.tech/packing/detect', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!detectResponse.ok) {
                    throw new Error(`❌ Server responded with ${detectResponse.status}: ${detectResponse.statusText}`);
                }

                const result = await detectResponse.json();
                // console.log('✅ Detection result:', result);

                captureBtn.disabled = false;
                buttonText.textContent = "📸 ถ่ายภาพ";
                spinner.classList.add("hidden");

                // แสดงรายการวัตถุที่ตรวจพบ
                detectionList.innerHTML = '';
                if (result.detections.length > 0) {
                    result.detections.forEach(det => {
                        const listItem = document.createElement('div');
                        listItem.innerHTML = `<strong>${det.label}</strong> - ความมั่นใจ: ${(det.confidence * 100).toFixed(1)}%`;
                        detectionList.appendChild(listItem);
                    });
                } else {
                    detectionList.innerHTML = `<div class="text-red-500 font-semibold">❌ AI ไม่สามารถตรวจจับสินค้าได้</div>`;
                }



                const imgURL = URL.createObjectURL(imageBlob);
                capturedImage.src = imgURL;
                capturedImage.classList.remove('hidden');
                capturedImage.onclick = () => {
                    modal.style.display = 'block';
                    modalImg.src = capturedImage.src;
                };


            } catch (error) {
                console.error('❌ Error capturing and detecting image:', error.message);
                detectionList.innerHTML = `<div class="text-red-500 font-semibold">${error.message}</div>`;

                captureBtn.disabled = false;
                buttonText.textContent = "📸 ถ่ายภาพ";
                spinner.classList.add("hidden");
            }
        });


        async function verifyOrder(orderId, isVerified) {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];

            if (!token) {
                alert("❌ No Authorization Token Found");
                return;
            }

            const formData = new FormData();
            formData.append("verified", isVerified);

            // ✅ ตรวจสอบว่ามีรูปที่ถ่ายไว้หรือไม่
            const capturedImage = document.getElementById('captured-image');
            if (capturedImage.src && capturedImage.src.startsWith("blob")) {
                const response = await fetch(capturedImage.src);
                const blob = await response.blob();
                formData.append("file", blob, "captured_image.jpg");
            } else {
                alert("❌ กรุณาตรวจจับสินค้าก่อนกดยืนยัน");
                return;
            }

            // ✅ DEBUG: ตรวจสอบค่าที่ถูกส่งไป
            // console.log("🔍 FormData ส่งไป:", formData);

            try {
                const response = await fetch(`http://localhost:8001/packing/orders/${orderId}/verify`, {
                    // const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/verify`, {
                    method: "PUT",
                    headers: { "Authorization": `Bearer ${token}` },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail);
                }

                alert(result.message);

                // FIXME: ไม่อยากให้รีโหลดทั้งหน้าอยากให้รีโหลดแค่ 
                // 📦 รายการคำสั่งซื้อที่กำลัง Packing และ 📦 รายละเอียดออเดอร์ที่กำลังบรรจุ
                window.location.reload();
            } catch (error) {
                alert("❌ " + error.message);
            }
        }


        // ปิด Modal เมื่อคลิกปุ่มปิด
        closeModal.onclick = () => {
            modal.style.display = 'none';
        };

    </script>
</body>

</html>