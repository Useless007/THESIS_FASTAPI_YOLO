<!-- # app/templates/packing_dashboard.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Staff Camera Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <style>
        /* Container wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö video stream, spinner ‡πÅ‡∏•‡∏∞ overlay */
        .video-container {
            position: relative;
            display: inline-block;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û stream */
        #stream {
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 640px;
            height: 480px;
            display: block;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin: -25px 0 0 -25px;
            /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î */
        #camera-off-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 8px;
            z-index: 15;
            display: none;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
        #canvas {
            display: none;
        }

        #detection-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
        }

        .captured-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .captured-image-wrapper {
            position: relative;
            cursor: pointer;
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .captured-image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            margin: 5% auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
        }

        .modal img {
            width: 100%;
            height: auto;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>

    <script>
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ packing orders
        document.addEventListener('DOMContentLoaded', () => {
            loadCameraList();
            loadPackingOrders();
        });
    </script>

</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-md p-4">
        <div class="max-w-screen-xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üì∑ Packing Staff Camera Dashboard (YOLOv10)</h1>
            <a href="/" class="text-blue-500 hover:underline">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>
    </nav>

    <main class="p-8 text-center">

        <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) -->
        <div class="mb-4">
            <label for="camera-dropdown" class="block mb-2 text-lg font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÇ‡∏ï‡πä‡∏∞):</label>
            <select id="camera-dropdown" class="border border-gray-300 rounded-md p-2">
                <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å populate ‡πÇ‡∏î‡∏¢ JavaScript -->
            </select>
        </div>


        <h2 class="text-2xl font-bold mb-6">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ YOLOv10 ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á</h2>

        <!-- Streaming Video -->
        <div class="flex justify-center mb-4">
            <div class="video-container">
                <div id="loading-spinner"></div>
                <img id="stream" src="">
                <!-- Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î -->
                <div id="camera-off-overlay">
                    <div style="font-size: 48px;">üö´</div>
                    <div>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4 mb-4">
            <button id="start-camera" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                disabled>üì∏
                ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button id="stop-camera" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">üõë
                ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button id="capture" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">üì∑
                ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
        </div>

        <!-- Detection Results -->
        <h3 class="text-lg font-bold mt-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</h3>
        <div id="detection-list" class="bg-white shadow-md text-gray-700"></div>

        <!-- Captured Image -->
        <h3 class="text-lg font-bold mt-4">üñºÔ∏è ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</h3>
        <div class="captured-container">
            <div class="captured-image-wrapper" id="captured-wrapper">
                <img id="captured-image" src="" alt="Captured Image" class="hidden">
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ packing -->
        <section class="mt-8">
            <h3 class="text-2xl font-bold mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</h3>
            <div id="packing-orders-list" class="bg-white shadow-md p-4 rounded-md">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </section>

    </main>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢ -->
    <div id="image-modal" class="modal">
        <span class="close" id="close-modal">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const stream = document.getElementById('stream');
        const detectionList = document.getElementById('detection-list');
        const capturedImage = document.getElementById('captured-image');
        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const captureBtn = document.getElementById('capture');
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const closeModal = document.getElementById('close-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const cameraOffOverlay = document.getElementById('camera-off-overlay');
        const cameraDropdown = document.getElementById('camera-dropdown');
        const packingOrdersList = document.getElementById('packing-orders-list');

        let currentCamera = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        loadingSpinner.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö

        // ‡∏ã‡πà‡∏≠‡∏ô spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å stream ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        stream.addEventListener('load', () => {
            loadingSpinner.style.display = 'none';
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô overlay ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
            cameraOffOverlay.style.display = 'none';
        });




        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å DB (‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ endpoint /packing/cameras ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON)
        async function loadCameraList() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('https://thesis-api.jintaphas.tech/packing/cameras', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching cameras: ${response.status}`);
                }
                const cameras = await response.json();
                // Populate dropdown
                cameraDropdown.innerHTML = '';
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ camera ‡∏°‡∏µ property table_number, name ‡πÅ‡∏•‡∏∞ stream_url
                    option.textContent = `‡πÇ‡∏ï‡πä‡∏∞ ${camera.table_number} - ‡∏Å‡∏•‡πâ‡∏≠‡∏á ${camera.name}`;
                    option.dataset.streamUrl = camera.stream_url;
                    cameraDropdown.appendChild(option);
                });
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (cameras.length > 0) {
                    currentCamera = cameras[0];
                    cameraDropdown.value = currentCamera.id;
                    stream.src = currentCamera.stream_url;
                    startCameraBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å dropdown ‡πÉ‡∏´‡πâ update ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á stream
        cameraDropdown.addEventListener('change', (e) => {
            const selectedOption = cameraDropdown.options[cameraDropdown.selectedIndex];
            currentCamera = {
                id: selectedOption.value,
                stream_url: selectedOption.dataset.streamUrl,
                table_number: selectedOption.textContent
            };
            stream.src = currentCamera.stream_url;
            startCameraBtn.disabled = false;
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ packing
        async function loadPackingOrders() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            try {
                const response = await fetch('https://thesis-api.jintaphas.tech/packing/orders/packing', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error fetching packing orders: ${response.status}`);
                }
                const orders = await response.json();
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = '';
                if (orders.length === 0) {
                    packingOrdersList.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Packing</p>';
                    return;
                }
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-center border-collapse border border-gray-200';
                table.innerHTML = `
                    <thead>
                      <tr class="bg-gray-200 text-gray-600 uppercase text-xs font-semibold">
                        <th class="py-2 px-3 border">Order ID</th>
                        <th class="py-2 px-3 border">Email</th>
                        <th class="py-2 px-3 border">Total</th>
                        <th class="py-2 px-3 border">Date</th>
                        <th class="py-2 px-3 border">Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á cell ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                    let actionCell = '';
                    if (order.assigned_to === null) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å assign ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô"
                        actionCell = `<button onclick="claimOrder(${order.id})" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤ already assigned (‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà assign ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                        actionCell = `<span class="text-green-600 font-semibold">In Progress</span>`;
                    }
                    tr.innerHTML = `
                        <td class="py-2 px-3 border">${order.id}</td>
                        <td class="py-2 px-3 border">${order.email}</td>
                        <td class="py-2 px-3 border">‡∏ø${order.total}</td>
                        <td class="py-2 px-3 border">${new Date(order.created_at).toLocaleDateString()}</td>
                        <td class="py-2 px-3 border">${actionCell}</td>
                    `;
                    tbody.appendChild(tr);
                });
                packingOrdersList.appendChild(table);
            } catch (error) {
                console.error(error);
                const packingOrdersList = document.getElementById('packing-orders-list');
                packingOrdersList.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Claim Order)
        async function claimOrder(orderId) {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('Authorization='))?.split('=')[1];
            if (!token) {
                alert("‚ùå No Authorization Token Found");
                return;
            }
            try {
                const response = await fetch(`https://thesis-api.jintaphas.tech/packing/orders/${orderId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to assign order");
                }
                const data = await response.json();
                alert(data.message);
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                loadPackingOrders();
            } catch (error) {
                console.error("Error claiming order:", error.message);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: " + error.message);
            }
        }






        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        startCameraBtn.addEventListener('click', async () => {
            try {
                const token = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];
                const cleanedToken = token ? token.replace(/"/g, '') : null;
                if (!cleanedToken) {
                    throw new Error('‚ùå No Authorization Token Found');
                }
                cameraOffOverlay.style.display = 'none';
                loadingSpinner.style.display = 'block';
                if (!currentCamera) return;
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ currentCamera.stream_url ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å backend stream endpoint
                stream.src = `https://thesis-api.jintaphas.tech/packing/stream?camera_id=${currentCamera.id}&token=${cleanedToken}`;
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                captureBtn.disabled = false;
            } catch (error) {
                console.error('‚ùå Error starting camera:', error.message);
            }
        });

        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        stopCameraBtn.addEventListener('click', async () => {
            stream.src = ''; // ‡∏õ‡∏¥‡∏î stream
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            captureBtn.disabled = true;
            cameraOffOverlay.style.display = 'flex';
            try {
                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];
                if (!token) throw new Error('‚ùå No Authorization Token Found');
                const response = await fetch('https://thesis-api.jintaphas.tech/packing/stop-stream', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error(`‚ùå Server responded with ${response.status}: ${response.statusText}`);
                }
                console.log("üõë Camera stream stopped.");
            } catch (error) {
                console.error('‚ùå Error stopping camera:', error.message);
            }
        });

        // ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        captureBtn.addEventListener('click', async () => {
            try {
                const token = document.cookie.split('; ')
                    .find(row => row.startsWith('Authorization='))?.split('=')[1];
                if (!token) throw new Error('‚ùå No Authorization Token Found');
                // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å stream
                const response = await fetch("https://thesis-api.jintaphas.tech/packing/snapshot", {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error(`‚ùå Server responded with ${response.status}: ${response.statusText}`);
                }
                const imageBlob = await response.blob();
                const formData = new FormData();
                formData.append('file', imageBlob, 'captured_image.png');
                console.log('üì∏ Sending captured image to backend...');
                const detectResponse = await fetch('https://thesis-api.jintaphas.tech/packing/detect', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (!detectResponse.ok) {
                    throw new Error(`‚ùå Server responded with ${detectResponse.status}: ${detectResponse.statusText}`);
                }
                const result = await detectResponse.json();
                console.log('‚úÖ Detection result:', result);
                detectionList.innerHTML = '';
                if (result.detections.length > 0) {
                    result.detections.forEach(det => {
                        const listItem = document.createElement('div');
                        listItem.innerHTML = `<strong>${det.label}</strong> - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(det.confidence * 100).toFixed(1)}%`;
                        detectionList.appendChild(listItem);
                    });
                } else {
                    detectionList.innerHTML = `<div class="text-red-500 font-semibold">‚ùå AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>`;
                }
                const imgURL = URL.createObjectURL(imageBlob);
                capturedImage.src = imgURL;
                capturedImage.classList.remove('hidden');
                capturedImage.onclick = () => {
                    modal.style.display = 'block';
                    modalImg.src = capturedImage.src;
                };
            } catch (error) {
                console.error('‚ùå Error capturing and detecting image:', error.message);
                detectionList.innerHTML = `<div class="text-red-500 font-semibold">${error.message}</div>`;
            }
        });

        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
        closeModal.onclick = () => {
            modal.style.display = 'none';
        };

    </script>
</body>

</html>