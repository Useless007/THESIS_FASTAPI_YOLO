<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Orders Management</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />

    <style>
        #fullscreenModal {
            backdrop-filter: blur(10px);
        }
    </style>

</head>

<body class="bg-gray-100">

    <!-- Navbar -->
    <nav class="bg-white shadow-md p-4">
        <div class="max-w-screen-xl mx-auto flex justify-between items-center">
            <a href="/admin/dashboard" class="text-xl font-bold">üëë Orders Management</a>
            <a href="/" class="text-blue-500 hover:underline">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-8">
        <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
            <h1 class="text-5xl font-bold text-center">Orders Management</h1>
            <div class="overflow-hidden bg-white shadow-sm sm:rounded-lg mt-10">
                <ul role="list" class="divide-y divide-gray-200 opacity-100" id="order-list">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </ul>
            </div>
        </div>
    </main>

    <!-- Modal Popup for Order Details -->
    <div id="orderModal" class="fixed inset-0 hidden bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
            <div class="mt-2 space-y-2">
                <p><strong>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="modal-email"></span></p>
                <p><strong>üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <span id="modal-item"></span></p>
                <p><strong>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</strong> ‡∏ø<span id="modal-total"></span></p>
                <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> <span id="modal-created"></span></p>
                <p><strong>üñºÔ∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong></p>
                <div class="mt-2">
                    <img id="modal-slip" src="" alt="‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
                        class="w-full h-48 object-contain border rounded-md" />
                </div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md">‡∏õ‡∏¥‡∏î</button>
                <button onclick="approveOrder()" class="bg-green-500 text-white px-4 py-2 rounded-md">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                <button onclick="cancelOrder()" class="bg-red-500 text-white px-4 py-2 rounded-md">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image Modal -->
    <div id="fullscreenModal" class="fixed inset-0 hidden bg-black bg-opacity-90 flex justify-center items-center z-50">
        <span class="absolute top-4 right-4 text-white text-4xl cursor-pointer"
            onclick="closeFullscreenModal()">&times;</span>
        <img id="fullscreen-image" src="" alt="‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="max-w-full max-h-full object-contain">
    </div>


    <script>
        let selectedOrderId = null; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏•‡∏¥‡∏õ
        $(document).ready(function() {
            $.getJSON("/admin/pending_order", function(data) {
                var orderList = $("#order-list");
                orderList.empty(); // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤
        
                data.orders.forEach(function(order) {
                    let items = Array.isArray(order.item) ? order.item : [];
        
                    let itemList = items.map(item => {
                        if (item.error) {
                            return `<span class="text-red-500">‚ùå ${item.error}</span>`;
                        }
                        // ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å item.name ‡πÄ‡∏õ‡πá‡∏ô item.product_name
                        return `${item.product_name} (x${item.quantity})`;
                    }).join(', ');
        
                    var listItem = `
                        <li data-id="${order.id}">
                            <div class="block hover:bg-gray-50">
                                <div class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <div class="truncate text-sm font-medium text-indigo-600">
                                            ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${order.email}
                                        </div>
                                    </div>
                                    <div class="mt-2 flex justify-between">
                                        <div class="text-sm text-gray-500">
                                            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${itemList}
                                        </div>
                                        <button onclick="openModal(
                                            ${order.id}, 
                                            '${order.email}', 
                                            '${encodeURIComponent(JSON.stringify(items))}', 
                                            ${order.total}, 
                                            '${order.created_at}', 
                                            '${order.slip_path || ''}'
                                        )" class="bg-blue-200 rounded p-2">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `;
                    orderList.append(listItem);
                });
            });
        });
        
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏•‡∏¥‡∏õ
        function openModal(orderId, email, item, total, created_at, slipPath) {
            selectedOrderId = orderId; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ID ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        
            let parsedItems = JSON.parse(decodeURIComponent(item));
            // ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å item.name ‡πÄ‡∏õ‡πá‡∏ô item.product_name ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
            let itemList = parsedItems.map(item => `üìå ${item.product_name} (x${item.quantity})`).join('<br>');
        
            $('#modal-email').text(email);
            $('#modal-item').html(itemList); // ‡πÉ‡∏ä‡πâ .html() ‡πÅ‡∏ó‡∏ô .text() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö <br>
            $('#modal-total').text(total);
            $('#modal-created').text(created_at);
        
            if (slipPath) {
                $('#modal-slip').attr('src', slipPath).show();
        
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ
                $('#modal-slip').off('click').on('click', function() {
                    openFullscreenModal(slipPath);
                });
            } else {
                $('#modal-slip').attr('src', '').hide();
            }
        
            $('#orderModal').removeClass('hidden');
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
        function openFullscreenModal(imagePath) {
            $('#fullscreen-image').attr('src', imagePath);
            $('#fullscreenModal').removeClass('hidden');
        }

        // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
        function closeFullscreenModal() {
            $('#fullscreenModal').addClass('hidden');
            $('#fullscreen-image').attr('src', '');
        }
        // ‡∏õ‡∏¥‡∏î Modal
        function closeModal() {
            $('#orderModal').addClass('hidden');
        }


        // Approve Order
        function approveOrder() {
            // console.log("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", selectedOrderId);

            $.ajax({
                url: `/admin/orders/${selectedOrderId}/approve`,
                type: 'PUT',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                success: function (response) {
                    // console.log("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", response);
                    alert(`‚úÖ Order ${selectedOrderId} approved successfully.`);
                    $(`#order-list li[data-id="${selectedOrderId}"]`).remove(); // ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    closeModal();
                },
                error: function (xhr, status, error) {
                    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", xhr.responseJSON.detail || error);
                    alert(`‚ùå Failed to approve order: ${xhr.responseJSON.detail || error}`);
                }
            });
        }

        // Cancel Order
        function cancelOrder() {
            // console.log("üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", selectedOrderId);

            $.ajax({
                url: `/admin/orders/${selectedOrderId}/cancel`,
                type: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                success: function (response) {
                    // console.log("‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", response);
                    alert(`‚úÖ Order ${selectedOrderId} canceled successfully.`);
                    $(`#order-list li[data-id="${selectedOrderId}"]`).remove(); // ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    closeModal();
                },
                error: function (xhr, status, error) {
                    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", xhr.responseJSON.detail || error);
                    alert(`‚ùå Failed to cancel order: ${xhr.responseJSON.detail || error}`);
                }
            });
        }
    </script>
</body>

</html>