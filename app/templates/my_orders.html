<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <nav class="bg-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-lg font-bold">MasterLeng Shop</a>
            <a href="/logout" class="text-gray-700 hover:text-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </nav>

    <main class="container mx-auto my-8 p-4 bg-white rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4">üõí ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
        <div id="orders-container" class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                        <th class="py-2 px-4 border-b">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                        <th class="py-2 px-4 border-b">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="py-2 px-4 border-b">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                        <th class="py-2 px-4 border-b">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πàcompleted‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á -->
                        <th id="image-header" class="py-2 px-4 border-b" style="display: none;">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    </tr>
                </thead>
                <tbody id="orders-table">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô JavaScript -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
                const [name, value] = cookie.split('=');
                acc[name] = value;
                return acc;
            }, {});

            const token = cookies['Authorization'] ? cookies['Authorization'].replace('Bearer ', '') : null;

            fetch('/orders/my-orders', {
                method: 'GET',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ');
                    }
                    return response.json();
                })
                .then(orders => {
                    const table = document.getElementById('orders-table');
                    table.innerHTML = '';

                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà `completed` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const hasCompletedOrder = orders.some(order => order.status === "completed" && order.image_path);

                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ "completed" orders
                    const tableHeader = document.getElementById('image-header');
                    if (hasCompletedOrder) {
                        tableHeader.style.display = "table-cell";  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                    } else {
                        tableHeader.style.display = "none";  // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ "completed"
                    }

                    orders.forEach(order => {
                        let viewImageButton = '';

                        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "completed" ‡πÅ‡∏•‡∏∞‡∏°‡∏µ `image_path` ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
                        if (order.status === "completed" && order.image_path) {
                            viewImageButton = `
                                <button 
                                    class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 block mx-auto" 
                                    onclick="showPackedImage('${order.order_id}')"
                                >
                                    üì∏ ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß
                                </button>
                            `;
                        }

                        const row = `
                            <tr>
                                <td class="py-2 px-4 border-b">${order.order_id}</td>
                                <td class="py-2 px-4 border-b">${new Date(order.created_at).toLocaleDateString()}</td>
                                <td class="py-2 px-4 border-b">${order.status}</td>
                                <td class="py-2 px-4 border-b">‡∏ø${order.total}</td>
                                <td class="py-2 px-4 border-b text-center">
                                    <button 
                                        class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600" 
                                        onclick="showOrderDetails('${order.order_id}')"
                                    >
                                        üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                    </button>
                                </td>
                                <td class="py-2 px-4 border-b text-center" style="${hasCompletedOrder ? 'display: table-cell;' : 'display: none;'}">
                                    ${viewImageButton}
                                </td>
                            </tr>
                        `;
                        table.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    document.getElementById('orders-container').innerHTML = '<p class="text-red-500">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';
                });
        });

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        function showOrderDetails(orderId) {
            const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
                const [name, value] = cookie.split('=');
                acc[name] = value;
                return acc;
            }, {});

            const token = cookies['Authorization'] ? cookies['Authorization'].replace('Bearer ', '') : null;

            fetch(`/orders/${orderId}/items`, {
                method: 'GET',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
                    }
                    return response.json();
                })
                .then(items => {
                    let itemsList = items.map(item => `
                        <div class="flex justify-between items-center mb-2 pb-2 border-b">
                            <div>
                                <p class="font-medium">${item.product_name}</p>
                                <p class="text-sm text-gray-600">‡∏ø${item.price_at_order} x ${item.quantity}</p>
                            </div>
                            <p class="font-semibold">‡∏ø${item.total_item_price}</p>
                        </div>
                    `).join('');

                    Swal.fire({
                        title: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #${orderId}`,
                        html: `
                            <div class="text-left">
                                ${itemsList}
                                <div class="flex justify-between items-center mt-4 pt-4 border-t">
                                    <p class="font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                    <p class="font-bold text-lg">‡∏ø${items.reduce((sum, item) => sum + item.total_item_price, 0)}</p>
                                </div>
                            </div>
                        `,
                        width: '600px',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: '‡∏õ‡∏¥‡∏î'
                    });
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Modal
        function showPackedImage(orderId) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');

            // ‚úÖ ‡πÉ‡∏ä‡πâ API `/orders/{order_id}/image` ‡πÅ‡∏ó‡∏ô `image_path` ‡∏ï‡∏£‡∏á‡πÜ
            modalImg.src = `http://localhost:8001/packing/orders/${orderId}/image`;
            // modalImg.src = `https://thesis-api.jintaphas.tech/packing/orders/${orderId}/image`;

            modal.style.display = "block";

            document.getElementById('close-modal').onclick = () => {
                modal.style.display = "none";
            };
        }

    </script>

    <!-- ‚úÖ Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-4 rounded-lg shadow-lg relative">
            <span id="close-modal" class="absolute top-2 right-2 text-xl cursor-pointer">&times;</span>
            <img id="modal-image" src="" class="max-w-full max-h-[80vh] rounded-lg">
        </div>
    </div>

</body>

</html>