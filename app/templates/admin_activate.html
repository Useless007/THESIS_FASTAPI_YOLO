<!-- app/templates/admin_activate.html -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>Activate Management</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />

  <style>
    #user-list li.no-users {
      text-align: center;
      color: #6b7280;
      /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ Tailwind */
      font-size: 1rem;
      padding: 1rem;
    }
  </style>
</head>

<body class="bg-gray-100">
  <nav class="bg-white shadow-md p-4">
    <div class="max-w-screen-xl mx-auto flex justify-between items-center">
      <a href="/admin/dashboard" class="text-xl font-bold">üëë Activate Management</a>
      <a href="/" class="text-blue-500 hover:underline">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    </div>
  </nav>

  <main class="p-8">
    <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-none">
        <h1 class="text-5xl font-bold text-center">Activate Management</h1>

        <button class="p-4 bg-green-300 hover:bg-green-500 rounded-md mt-5" onclick="openRoleModal()">
          üõ†Ô∏è ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        </button>


        <div class="overflow-hidden bg-white shadow-sm sm:rounded-lg mt-10">
          <ul role="list" class="divide-y divide-gray-200 opacity-100" id="user-list">
            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ jQuery -->
          </ul>
        </div>
      </div>
    </div>
  </main>




  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏® -->
  <div id="roleModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <h3 class="text-lg font-semibold">üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏®</h3>
      <div class="mt-2 space-y-2">
        <label for="user-select" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
        <select id="user-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring">

        </select>
        <label for="role-select" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏®:</label>
        <select id="role-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring">
          <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
          <option value="packing staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏û‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option value="preparation staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        </select>
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button onclick="closeRoleModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md">‡∏õ‡∏¥‡∏î</button>
        <button onclick="assignRoleAndActivate()" class="bg-blue-500 text-white px-4 py-2 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Activate
      $.getJSON("/admin/employees-to-activate", function (users) {
        var userList = $("#user-list");
        userList.empty(); // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤

        if (users.length === 0) {
          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ
          userList.append(`
                  <li>
                      <div class="p-4 text-center text-gray-500">
                          üõ°Ô∏è ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                      </div>
                  </li>
              `);
          return;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
        users.forEach(function (user) {
          var listItem = `
                  <li data-id="${user.id}">
                      <div class="block hover:bg-gray-50">
                          <div class="px-4 py-4 sm:px-6">
                              <div class="flex items-center justify-between">
                                  <div class="truncate text-sm font-medium text-indigo-600">
                                      ${user.name}
                                  </div>
                              </div>
                              <div class="mt-2 flex justify-between">
                                  <div class="sm:flex">
                                      <div class="mr-6 flex items-center text-sm text-gray-500">
                                          <svg class="mr-1.5 size-5 shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                              <path d="M7 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM14.5 9a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM1.615 16.428a1.224 1.224 0 0 1-.569-1.175 6.002 6.002 0 0 1 11.908 0c.058.467-.172.92-.57 1.174A9.953 9.953 0 0 1 7 18a9.953 9.953 0 0 1-5.385-1.572ZM14.5 16h-.106c.07-.297.088-.611.048-.933a7.47 7.47 0 0 0-1.588-3.755 4.502 4.502 0 0 1 5.874 2.636.818.818 0 0 1-.36.98A7.465 7.465 0 0 1 14.5 16Z"></path>
                                          </svg>
                                          ${user.position || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'}
                                      </div>
                                  </div>
                                  <div class="flex items-center text-sm text-gray-500 space-x-2">
                                      <button class="bg-red-200 rounded p-2" onclick="deleteUser(${user.id})">‚ùå</button>
                                      <button class="bg-green-200 rounded p-2" onclick="activateUser(${user.id})">‚úî</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </li>
              `;
          userList.append(listItem);
        });
      }).fail(function (error) {
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:", error.responseJSON?.detail || error);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
      });
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Activate User ‡∏ú‡πà‡∏≤‡∏ô jQuery AJAX
    function activateUser(userId) {
      // console.log("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", userId);

      $.ajax({
        url: `/admin/${userId}/activate`,
        type: 'PUT',
        contentType: 'application/json',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        success: function (response) {
          // console.log("‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", response);
          alert(`‚úÖ User ${userId} activated successfully.`);
          $(`#user-list li[data-id="${userId}"]`).remove(); // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà Activate ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        },
        error: function (xhr, status, error) {
          console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", xhr.responseJSON.detail || error);
          alert(`‚ùå Failed to activate user: ${xhr.responseJSON.detail || error}`);
        }
      });
    }
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Delete User ‡∏ú‡πà‡∏≤‡∏ô jQuery AJAX
    function deleteUser(userId) {
      // console.log("üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", userId);

      $.ajax({
        url: `/admin/${userId}`,
        type: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        success: function (response) {
          // console.log("‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", response);
          alert(`‚úÖ User ${userId} deleted successfully.`);
          $(`#user-list li[data-id="${userId}"]`).remove(); // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        },
        error: function (xhr, status, error) {
          console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", xhr.responseJSON.detail || error);
          alert(`‚ùå Failed to delete user: ${xhr.responseJSON.detail || error}`);
        }
      });
    }
  </script>

  <script>
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal
    function openRoleModal() {
      $('#roleModal').removeClass('hidden');

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Customer ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Active
      $.getJSON("/admin/customers-to-activate", function (data) {
        let userSelect = $('#user-select');
        userSelect.empty(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

        data.customers.forEach(user => {
          userSelect.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
        });
      }).fail(function (error) {
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:", error.responseJSON?.detail || error);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
      });
    }

    // ‡∏õ‡∏¥‡∏î Modal
    function closeRoleModal() {
      $('#roleModal').addClass('hidden');
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏®‡πÅ‡∏•‡∏∞ Activate ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    function assignRoleAndActivate() {
      const userId = $('#user-select').val();
      const role = $('#role-select').val();

      if (!userId || !role) {
        alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏®');
        return;
      }

      $.ajax({
        url: `/admin/users/${userId}/change-role?role=${role}`,
        type: 'PUT',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        success: function (response) {
          // console.log("‚úÖ Role ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", response);
          closeRoleModal();
          alert(`‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏®‡πÅ‡∏•‡∏∞ Activate ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
          location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role
        },
        error: function (xhr, status, error) {
          console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role:", xhr.responseJSON?.detail || error);
          alert(`‚ùå Failed to change role: ${xhr.responseJSON?.detail || error}`);
        }
      });
    }

  </script>

</body>

</html>